# PostgreSQL WAL 구조와 작동방식

#### XLOG(Transaction Log) 레코드
- 트랜잭션 로그 레코드라고 읽는다.
- 변경내용을 기록하는 단위이다.
- XLOGRecord 구조체 ([출처 링크](https://dev.to/vkt1271/summary-of-chapter-9-write-ahead-logging-wal-from-the-book-the-internals-of-postgresql-part-3-1mef#:~:text=All%20XLOG%20records%20have%20a,and%20replaying%20of%20XLOG%20records.))
  ```
  typedef struct XLogRecord
  {
     uint32          xl_tot_len;   /* total len of entire record */
     TransactionId   xl_xid;       /* xact id */
     uint32          xl_len;       /* total len of rmgr data */
     uint8           xl_info;      /* flag bits, see below */
     RmgrId          xl_rmid;      /* resource manager for this record */
     /* 2 bytes of padding here, initialize to zero */
     XLogRecPtr      xl_prev;      /* ptr to previous record in log */
     pg_crc32        xl_crc;       /* CRC for this record */
  } XLogRecord;****
  ```
  - xl_tot_len : 전체 레코드의 길이
  - xl_xid : 트랜잭션ID
  - xl_len : rmgr데이터의 총 길이
  - xl_info : flag비트
  - sl_rmid : 이 레코드에 대한 리소스매니저'
  - xl_pref : 로그 내에서의 이전 레코드 포인터
  - xl_crc : 이 레코드에 대한 CRC

#### LSN(Log Sequence Number)
- WAL Buffer 또는 WAL Segment파일에 XLOG를 남기는 순번을 이야기한다.

#### 체크포인트(Checkpoint)
- Shared Buffer에 있는 모든 Dirty Buffer를 디스크의 데이터파일에 기록함.
- XLOG레코드에 'checkpoint' 기록
- 체크포인트할 때마다 해당 시점의 LSN, WAL Segment파일을 pg_control 파일에 기록한다. Crash Recovery 수행 시 복원할 XLOG의 시작점을 알기 위함이다.
- pg_control파일의 체크포인트에 관한 기록 예시
  ```
  $ pg_controldata -D /path/to/pgdata
  pg_control version number:            1201
  Catalog version number:               201909212
  Database system identifier:           6872135480623396628
  Database cluster state:               in archive recovery
  pg_control last modified:             Mon 14 Sep 2020 09:35:29 AM UTC
  Latest checkpoint location:           0/2000060
  Latest checkpoint's REDO location:    0/2000028
  Latest checkpoint's REDO WAL file:    000000010000000000000002
  Latest checkpoint's TimeLineID:       1
  Latest checkpoint's PrevTimeLineID:   1
  Latest checkpoint's full_page_writes: on
  Latest checkpoint's NextXID:          0:495
  Latest checkpoint's NextOID:          24576
  Latest checkpoint's NextMultiXactId:  1
  Latest checkpoint's NextMultiOffset:  0
  Latest checkpoint's oldestXID:        479
  Latest checkpoint's oldestXID's DB:   1
  Latest checkpoint's oldestActiveXID:  495
  Latest checkpoint's oldestMultiXid:   1
  Latest checkpoint's oldestMulti's DB: 1
  Latest checkpoint's oldestCommitTsXid:0
  Latest checkpoint's newestCommitTsXid:0
  Time of latest checkpoint:            Mon 14 Sep 2020 09:35:28 AM U
  ```

#### 커밋 (Commit)
- 진행중이던 트랜잭션을 완료하기 위한 명령어.
- 커밋 시점 동작
  1. XLOG레코드에 'commit'레코드 기록
  2. WAL Buffer에 적재
  3. WAL Buffer의 레코드를 DB클러스터의 WAL Segment 파일로 flush한다.


