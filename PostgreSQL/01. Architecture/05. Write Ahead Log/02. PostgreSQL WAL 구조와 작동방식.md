# PostgreSQL WAL 구조와 작동방식

#### XLOG(Transaction Log) 레코드
- 트랜잭션 로그 레코드라고 읽는다.
- 변경내용을 기록하는 단위이다.

#### WAL Dump를 통한 XLOG레코드 분석
다음 작업을 수행하였다
```
create database nano;
\c nano
create table test1 (col1 int primary key);

insert into test1 values (1);
insert into test1 values (2);
insert into test1 values (3);
insert into test1 values (4);
insert into test1 values (5);
insert into test1 values (6);
insert into test1 values (7);
insert into test1 values (8);
insert into test1 values (9);
insert into test1 values (10);
insert into test1 values (11);
insert into test1 values (12);
insert into test1 values (13);
insert into test1 values (14);
insert into test1 values (15);
insert into test1 values (16);
insert into test1 values (17);
insert into test1 values (18);
insert into test1 values (19);
insert into test1 values (20);
insert into test1 values (21);
```
이에 대한 WAL Log는 다음과 같다.
```
[postgres@postrm02 archive]$ pg_waldump 000000050000000000000005  | grep 16450
rmgr: Storage     len (rec/tot):     42/    42, tx:        547, lsn: 0/05001030, prev 0/05001000, desc: CREATE base/16449/16450
rmgr: Transaction len (rec/tot):    645/   645, tx:        547, lsn: 0/0501B440, prev 0/0501B380, desc: COMMIT 2025-02-14 22:30:00.144748 UTC; inval msgs: catcache 50 catcache 49 catcache 50 catcache 49 catcache 50 catcache 49 catcache 7 catcache 6 catcache 32 catcache 19 catcache 75 catcache 74 catcache 75 catcache 74 catcache 50 catcache 49 catcache 7 catcache 6 catcache 7 catcache 6 catcache 7 catcache 6 catcache 7 catcache 6 catcache 7 catcache 6 catcache 7 catcache 6 catcache 7 catcache 6 relcache 16450 relcache 16453 relcache 16453 relcache
 16450 snapshot 2608 snapshot 2608 relcache 16450
rmgr: Heap        len (rec/tot):     59/    59, tx:        548, lsn: 0/0501B6C8, prev 0/0501B440, desc: INSERT+INIT off 1 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        549, lsn: 0/0501B7D0, prev 0/0501B7A8, desc: INSERT off 2 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        550, lsn: 0/0501B878, prev 0/0501B850, desc: INSERT off 3 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        551, lsn: 0/0501B920, prev 0/0501B8F8, desc: INSERT off 4 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        552, lsn: 0/0501B9C8, prev 0/0501B9A0, desc: INSERT off 5 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        553, lsn: 0/0501BA70, prev 0/0501BA48, desc: INSERT off 6 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        554, lsn: 0/0501BB18, prev 0/0501BAF0, desc: INSERT off 7 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        555, lsn: 0/0501BBC0, prev 0/0501BB98, desc: INSERT off 8 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        556, lsn: 0/0501BC68, prev 0/0501BC40, desc: INSERT off 9 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        557, lsn: 0/0501BD10, prev 0/0501BCE8, desc: INSERT off 10 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        558, lsn: 0/0501BDB8, prev 0/0501BD90, desc: INSERT off 11 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        559, lsn: 0/0501BE60, prev 0/0501BE38, desc: INSERT off 12 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        560, lsn: 0/0501BF08, prev 0/0501BEE0, desc: INSERT off 13 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        561, lsn: 0/0501BFB0, prev 0/0501BF88, desc: INSERT off 14 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        562, lsn: 0/0501C070, prev 0/0501C048, desc: INSERT off 15 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        563, lsn: 0/0501C118, prev 0/0501C0F0, desc: INSERT off 16 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        564, lsn: 0/0501C1C0, prev 0/0501C198, desc: INSERT off 17 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        565, lsn: 0/0501C268, prev 0/0501C240, desc: INSERT off 18 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        566, lsn: 0/0501C310, prev 0/0501C2E8, desc: INSERT off 19 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        567, lsn: 0/0501C3B8, prev 0/0501C390, desc: INSERT off 20 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
rmgr: Heap        len (rec/tot):     59/    59, tx:        568, lsn: 0/0501C460, prev 0/0501C438, desc: INSERT off 21 flags 0x00, blkref #0: rel 1663/16449/16450 blk 0
[postgres@postrm02 archive]$
```
- 바로 위의 rmgr로 시작하는 줄 하나하나가 XLOG Record이다.
- rmgr : 작업을 실행한 오브젝트 유형을 말한다.
  - Insert쿼리 실행 시의 rmgr은 Heap이므로 테이블에서 행해졌다는 것을 짐작할 수 있다.
  - create table 명령의 rmgr은 Storage이다.
  - Commit의 rmgr은 Transaction이다.
 - len(rec/tot)은 XLOG Record의 길이를 말한다.
 - tx : TxID를 말한다.
 - lsn : Log Sequence Number이다. WAL Log상의 위치를 의미한다.
 - prev : 이전 LSN을 가리킨다.
 - desc : 대략적인 작업내용을 말한다.
 - blkref : 블록번호를 말한다.
 - rel : 테이블의 oid를 말한다.

