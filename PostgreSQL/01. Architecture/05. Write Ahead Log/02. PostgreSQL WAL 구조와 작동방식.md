# PostgreSQL WAL 구조와 작동방식

#### XLOG(Transaction Log) 레코드
- 트랜잭션 로그 레코드라고 읽는다.
- 변경내용을 기록하는 단위이다.
- XLOGRecord 구조 설명 ([12버전 소스 링크](https://github.com/postgres/postgres/blob/REL_12_STABLE/src/include/access/xlogrecord.h), [트랜잭션로그 레코드 구조 설명](https://www.interdb.jp/blog/post/pgsql/pg95walformat/))

###### XLogRecord 구조체
- 모든 트랜잭션 로그 레코드에 공통적으로 들어가는 헤더이다.
- 구조체는 다음과 같다.
  ```
   typedef struct XLogRecord
   {
   	uint32		xl_tot_len;		/* total len of entire record */
   	TransactionId xl_xid;		/* xact id */
   	XLogRecPtr	xl_prev;		/* ptr to previous record in log */
   	uint8		xl_info;		/* flag bits, see below */
	  RmgrId		xl_rmid;		/* resource manager for this record */
	  /* 2 bytes of padding here, initialize to zero */
	  pg_crc32c	xl_crc;			/* CRC for this record */

	  /* XLogRecordBlockHeaders and XLogRecordDataHeader follow, no padding */

   } XLogRecord;
  ```
  - xl_tot_len: 해당 WAL 레코드의 전체 크기.
  - xl_xid: 이 WAL 레코드와 연관된 트랜잭션 ID.
  - xl_prev: 직전 WAL 레코드의 LSN(Log Sequence Number) 위치.
  - xl_info: 리소스 매니저가 사용하는 추가 정보.
  - xl_rmid: 리소스 매니저 ID(RMGR, Resource Manager)로, 어떤 서브시스템(테이블, 인덱스 등)이 이 WAL을 생성했는지 나타냄.
  - xl_crc: WAL 레코드의 데이터 무결성을 확인하기 위한 CRC 체크섬.

#### XLogRecord의 종류
1. Backup Block
   - 페이지나 버퍼 통째로 기록하는 레코드 유형이다.
   - 구조
     - **XLogRecord (general header-portion)**
     - XLogRecordBlockHeader including one LogRecordBlockImageHeader
     - XLogRecordDataHeaderShort
     - **a backup block (block data)** 
     - xl_heap_insert structure defined in htup.h (main data)  
3. Insert 시의 XLogRecord
   - Insert된 데이터의 정보가 레코드에 기록되는 유형이다.
   - 구조
     - **XLogRecord (general header-portion)**
     - XLogRecordBlockHeader
     - XLogRecordDataHeaderShort
     - **an inserted tuple (to be exact, a xl_heap_header structure and an inserted data entire)**
     - xl_heap_insert structure defined in htup.h (main data)
5. Checkpoint Block
   - 체크포인트 정보가 기록되는 유형이다.
   - 구조
     - **XLogRecord (general header-portion)**
     - XLogRecordDataHeaderShortcontained of the main data length
     - **CheckPoint structure defined in pg_control.h (main data)**
