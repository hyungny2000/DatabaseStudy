# PostgreSQL WAL 구조와 작동방식

#### XLOG(Transaction Log) 레코드
- 트랜잭션 로그 레코드라고 읽는다.
- 변경내용을 기록하는 단위이다.
- XLOGRecord 구조 설명 ([12버전 소스 링크](https://github.com/postgres/postgres/blob/REL_12_STABLE/src/include/access/xlogrecord.h))
  ```
   * The overall layout of an XLOG record is:
   *		Fixed-size header (XLogRecord struct)
   *		XLogRecordBlockHeader struct
   *		XLogRecordBlockHeader struct
   *		...
   *		XLogRecordDataHeader[Short|Long] struct
   *		block data
   *		block data
   *		...
   *		main data
  ```
  - XLogRecord 구조체로 된 헤더(XLogRecord Struct)
  - XLogRecordBlockHeader 구조체
  - XLogRecordDataHeader 구조체
  - 메인 데이터
 - XLogRecord 구조체 (트랜잭션 로그 헤더)
   ```
   typedef struct XLogRecord
   {
   	uint32		xl_tot_len;		/* total len of entire record */
   	TransactionId xl_xid;		/* xact id */
	   XLogRecPtr	xl_prev;		/* ptr to previous record in log */
	   uint8		xl_info;		/* flag bits, see below */
	   RmgrId		xl_rmid;		/* resource manager for this record */
	   /* 2 bytes of padding here, initialize to zero */
	   pg_crc32c	xl_crc;			/* CRC for this record */

	  /* XLogRecordBlockHeaders and XLogRecordDataHeader follow, no padding */

   } XLogRecord;
   ```
  - XLogRecordBlockHeader 구조체
    ```
    typedef struct XLogRecordBlockHeader
    {
	   uint8		id;				/* block reference ID */
	   uint8		fork_flags;		/* fork within the relation, and flags */
	   uint16		data_length;	/* number of payload bytes (not including page
							   	 * image) */
   
	   /* If BKPBLOCK_HAS_IMAGE, an XLogRecordBlockImageHeader struct follows */
	   /* If BKPBLOCK_SAME_REL is not set, a RelFileNode follows */
	   /* BlockNumber follows */
    } XLogRecordBlockHeader;
    ```
    
   - XLogRecordDataHeader 구조체    
    ```
    typedef struct XLogRecordDataHeaderShort
    {
	    uint8		id;				/* XLR_BLOCK_ID_DATA_SHORT */
	    uint8		data_length;	/* number of payload bytes */
    }			XLogRecordDataHeaderShort;

    typedef struct XLogRecordDataHeaderLong
    {
	    uint8		id;				/* XLR_BLOCK_ID_DATA_LONG */
	    /* followed by uint32 data_length, unaligned */
    }			XLogRecordDataHeaderLong;
    ```
