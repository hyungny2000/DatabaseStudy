## PostgreSQL WAL 구조와 작동방식

#### XLOG(Transaction Log) 레코드
- 트랜잭션 로그 레코드라고 읽는다.
- 변경내용을 기록하는 최소 단위이다.

#### WAL Dump를 통한 XLOG레코드 분석
waldump는 WAL Segment의 내용을 볼 수 있는 명령어다. 예를 들어 다음 작업을 수행하였다
```
nano=# select pg_current_wal_lsn();
 pg_current_wal_lsn
--------------------
 0/167B2C8
(1 row)

nano=# checkpoint;
CHECKPOINT
nano=# create table test1 (col1 int primary key);
CREATE TABLE
nano=# insert into test1 values (1);
INSERT 0 1
nano=# insert into test1 values (2);
INSERT 0 1
nano=# insert into test1 values (3);
INSERT 0 1
nano=# begin;
BEGIN
nano=# insert into test1 values (4);
INSERT 0 1
nano=# insert into test1 values (5);
INSERT 0 1
nano=# insert into test1 values (6);
INSERT 0 1
nano=# commit;
COMMIT
nano=# begin;
BEGIN
nano=# delete from test1 where col1 = 1;
DELETE 1
nano=# delete from test1 where col1 = 2;
DELETE 1
nano=# delete from test1 where col1 = 3;
DELETE 1
nano=# rollback;
ROLLBACK
nano=# select pg_current_wal_lsn();
 pg_current_wal_lsn
--------------------
 0/1692FC8
(1 row)

nano=# checkpoint;
CHECKPOINT
nano=#
```
이에 대한 waldump결과는 다음과 같다.

```
[postgres@postdb01 pg_wal]$ pg_wal -s 0/167B2C8 -e 0/1692FC8 000000010000000000000001
-bash: pg_wal: command not found
[postgres@postdb01 pg_wal]$ pg_waldump -s 0/167B2C8 -e 0/1692FC8 000000010000000000000001
rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/0167B2C8, prev 0/0167B290, desc: RUNNING_XACTS nextXid 505 latestCompletedXid 504 oldestRunningXid 505
rmgr: XLOG        len (rec/tot):    114/   114, tx:          0, lsn: 0/0167B300, prev 0/0167B2C8, desc: CHECKPOINT_ONLINE redo 0/167B2C8; tli 1; prev tli 1; fpw true; xid 0:505; oid 32768; multi 1; offset 0; oldest xid 479 in DB 1; oldest multi 1 in DB 1; oldest/newest commit timestamp xid: 0/0; oldest running xid 505; online
rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/0167B378, prev 0/0167B300, desc: RUNNING_XACTS nextXid 505 latestCompletedXid 504 oldestRunningXid 505
rmgr: Heap2       len (rec/tot):     59/  7387, tx:          0, lsn: 0/0167B3B0, prev 0/0167B378, desc: CLEAN remxid 504, blkref #0: rel 1663/16391/1247 blk 7 FPW
rmgr: Standby     len (rec/tot):     42/    42, tx:        505, lsn: 0/0167D0A8, prev 0/0167B3B0, desc: LOCK xid 505 db 16391 rel 24581
rmgr: Storage     len (rec/tot):     42/    42, tx:        505, lsn: 0/0167D0D8, prev 0/0167D0A8, desc: CREATE base/16391/24581
rmgr: Heap        len (rec/tot):    207/   207, tx:        505, lsn: 0/0167D108, prev 0/0167D0D8, desc: INSERT off 9 flags 0x00, blkref #0: rel 1663/16391/1247 blk 7
rmgr: Btree       len (rec/tot):     53/  1033, tx:        505, lsn: 0/0167D1D8, prev 0/0167D108, desc: INSERT_LEAF off 47, blkref #0: rel 1663/16391/2703 blk 2 FPW
rmgr: Btree       len (rec/tot):     53/  1917, tx:        505, lsn: 0/0167D5E8, prev 0/0167D1D8, desc: INSERT_LEAF off 24, blkref #0: rel 1663/16391/2704 blk 2 FPW
rmgr: Heap        len (rec/tot):     54/  7878, tx:        505, lsn: 0/0167DD68, prev 0/0167D5E8, desc: INSERT off 130 flags 0x00, blkref #0: rel 1663/16391/2608 blk 55 FPW
rmgr: Btree       len (rec/tot):     53/  1289, tx:        505, lsn: 0/0167FC48, prev 0/0167DD68, desc: INSERT_LEAF off 43, blkref #0: rel 1663/16391/2673 blk 33 FPW
rmgr: Btree       len (rec/tot):     53/  4369, tx:        505, lsn: 0/01680170, prev 0/0167FC48, desc: INSERT_LEAF off 153, blkref #0: rel 1663/16391/2674 blk 41 FPW
rmgr: Heap        len (rec/tot):    207/   207, tx:        505, lsn: 0/01681288, prev 0/01680170, desc: INSERT off 10 flags 0x00, blkref #0: rel 1663/16391/1247 blk 7
rmgr: Btree       len (rec/tot):     64/    64, tx:        505, lsn: 0/01681358, prev 0/01681288, desc: INSERT_LEAF off 47, blkref #0: rel 1663/16391/2703 blk 2
rmgr: Btree       len (rec/tot):     53/  5913, tx:        505, lsn: 0/01681398, prev 0/01681358, desc: INSERT_LEAF off 64, blkref #0: rel 1663/16391/2704 blk 1 FPW
rmgr: Heap        len (rec/tot):     80/    80, tx:        505, lsn: 0/01682AD0, prev 0/01681398, desc: INSERT off 131 flags 0x00, blkref #0: rel 1663/16391/2608 blk 55
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/01682B20, prev 0/01682AD0, desc: INSERT_LEAF off 43, blkref #0: rel 1663/16391/2673 blk 33
rmgr: Btree       len (rec/tot):     53/  2241, tx:        505, lsn: 0/01682B68, prev 0/01682B20, desc: INSERT_LEAF off 77, blkref #0: rel 1663/16391/2674 blk 39 FPW
rmgr: Heap        len (rec/tot):     54/  1226, tx:        505, lsn: 0/01683430, prev 0/01682B68, desc: INSERT off 4 flags 0x00, blkref #0: rel 1663/16391/1259 blk 0 FPW
rmgr: Btree       len (rec/tot):     53/  2433, tx:        505, lsn: 0/01683900, prev 0/01683430, desc: INSERT_LEAF off 117, blkref #0: rel 1663/16391/2662 blk 2 FPW
rmgr: Btree       len (rec/tot):     53/  4161, tx:        505, lsn: 0/016842A0, prev 0/01683900, desc: INSERT_LEAF off 98, blkref #0: rel 1663/16391/2663 blk 2 FPW
rmgr: Btree       len (rec/tot):     53/  1113, tx:        505, lsn: 0/016852E8, prev 0/016842A0, desc: INSERT_LEAF off 51, blkref #0: rel 1663/16391/3455 blk 4 FPW
rmgr: Heap        len (rec/tot):     54/  5426, tx:        505, lsn: 0/01685748, prev 0/016852E8, desc: INSERT off 34 flags 0x00, blkref #0: rel 1663/16391/1249 blk 38 FPW
rmgr: Btree       len (rec/tot):     53/  1553, tx:        505, lsn: 0/01686C98, prev 0/01685748, desc: INSERT_LEAF off 41, blkref #0: rel 1663/16391/2658 blk 15 FPW
rmgr: Btree       len (rec/tot):     53/  8113, tx:        505, lsn: 0/016872B0, prev 0/01686C98, desc: INSERT_LEAF off 401, blkref #0: rel 1663/16391/2659 blk 9 FPW
rmgr: Heap        len (rec/tot):    175/   175, tx:        505, lsn: 0/01689280, prev 0/016872B0, desc: INSERT off 35 flags 0x00, blkref #0: rel 1663/16391/1249 blk 38
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/01689330, prev 0/01689280, desc: INSERT_LEAF off 42, blkref #0: rel 1663/16391/2658 blk 15
rmgr: Btree       len (rec/tot):     64/    64, tx:        505, lsn: 0/01689378, prev 0/01689330, desc: INSERT_LEAF off 401, blkref #0: rel 1663/16391/2659 blk 9
rmgr: Heap        len (rec/tot):    175/   175, tx:        505, lsn: 0/016893B8, prev 0/01689378, desc: INSERT off 36 flags 0x00, blkref #0: rel 1663/16391/1249 blk 38
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/01689468, prev 0/016893B8, desc: INSERT_LEAF off 43, blkref #0: rel 1663/16391/2658 blk 15
rmgr: Btree       len (rec/tot):     64/    64, tx:        505, lsn: 0/016894B0, prev 0/01689468, desc: INSERT_LEAF off 401, blkref #0: rel 1663/16391/2659 blk 9
rmgr: Heap        len (rec/tot):    175/   175, tx:        505, lsn: 0/016894F0, prev 0/016894B0, desc: INSERT off 37 flags 0x00, blkref #0: rel 1663/16391/1249 blk 38
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/016895A0, prev 0/016894F0, desc: INSERT_LEAF off 41, blkref #0: rel 1663/16391/2658 blk 15
rmgr: Btree       len (rec/tot):     64/    64, tx:        505, lsn: 0/016895E8, prev 0/016895A0, desc: INSERT_LEAF off 401, blkref #0: rel 1663/16391/2659 blk 9
rmgr: Heap        len (rec/tot):    175/   175, tx:        505, lsn: 0/01689628, prev 0/016895E8, desc: INSERT off 38 flags 0x00, blkref #0: rel 1663/16391/1249 blk 38
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/016896D8, prev 0/01689628, desc: INSERT_LEAF off 44, blkref #0: rel 1663/16391/2658 blk 15
rmgr: Btree       len (rec/tot):     64/    64, tx:        505, lsn: 0/01689720, prev 0/016896D8, desc: INSERT_LEAF off 401, blkref #0: rel 1663/16391/2659 blk 9
rmgr: Heap        len (rec/tot):    175/   175, tx:        505, lsn: 0/01689760, prev 0/01689720, desc: INSERT off 39 flags 0x00, blkref #0: rel 1663/16391/1249 blk 38
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/01689810, prev 0/01689760, desc: INSERT_LEAF off 41, blkref #0: rel 1663/16391/2658 blk 15
rmgr: Btree       len (rec/tot):     64/    64, tx:        505, lsn: 0/01689858, prev 0/01689810, desc: INSERT_LEAF off 401, blkref #0: rel 1663/16391/2659 blk 9
rmgr: Heap        len (rec/tot):    175/   175, tx:        505, lsn: 0/01689898, prev 0/01689858, desc: INSERT off 40 flags 0x00, blkref #0: rel 1663/16391/1249 blk 38
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/01689948, prev 0/01689898, desc: INSERT_LEAF off 45, blkref #0: rel 1663/16391/2658 blk 15
rmgr: Btree       len (rec/tot):     64/    64, tx:        505, lsn: 0/01689990, prev 0/01689948, desc: INSERT_LEAF off 401, blkref #0: rel 1663/16391/2659 blk 9
rmgr: Heap2       len (rec/tot):     64/    64, tx:        505, lsn: 0/016899D0, prev 0/01689990, desc: CLEAN remxid 504, blkref #0: rel 1663/16391/2608 blk 55
rmgr: Heap        len (rec/tot):     80/    80, tx:        505, lsn: 0/01689A10, prev 0/016899D0, desc: INSERT off 132 flags 0x00, blkref #0: rel 1663/16391/2608 blk 55
rmgr: Btree       len (rec/tot):     53/  6553, tx:        505, lsn: 0/01689A60, prev 0/01689A10, desc: INSERT_LEAF off 224, blkref #0: rel 1663/16391/2673 blk 32 FPW
rmgr: Btree       len (rec/tot):     53/  5993, tx:        505, lsn: 0/0168B418, prev 0/01689A60, desc: INSERT_LEAF off 126, blkref #0: rel 1663/16391/2674 blk 21 FPW
rmgr: Storage     len (rec/tot):     42/    42, tx:        505, lsn: 0/0168CBA0, prev 0/0168B418, desc: CREATE base/16391/24584
rmgr: Standby     len (rec/tot):     42/    42, tx:        505, lsn: 0/0168CBD0, prev 0/0168CBA0, desc: LOCK xid 505 db 16391 rel 24584
rmgr: Heap        len (rec/tot):    203/   203, tx:        505, lsn: 0/0168CC00, prev 0/0168CBD0, desc: INSERT off 5 flags 0x00, blkref #0: rel 1663/16391/1259 blk 0
rmgr: Btree       len (rec/tot):     64/    64, tx:        505, lsn: 0/0168CCD0, prev 0/0168CC00, desc: INSERT_LEAF off 118, blkref #0: rel 1663/16391/2662 blk 2
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/0168CD10, prev 0/0168CCD0, desc: INSERT_LEAF off 100, blkref #0: rel 1663/16391/2663 blk 2
rmgr: Btree       len (rec/tot):     64/    64, tx:        505, lsn: 0/0168CD58, prev 0/0168CD10, desc: INSERT_LEAF off 52, blkref #0: rel 1663/16391/3455 blk 4
rmgr: Heap        len (rec/tot):    175/   175, tx:        505, lsn: 0/0168CD98, prev 0/0168CD58, desc: INSERT off 41 flags 0x00, blkref #0: rel 1663/16391/1249 blk 38
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/0168CE48, prev 0/0168CD98, desc: INSERT_LEAF off 48, blkref #0: rel 1663/16391/2658 blk 15
rmgr: Btree       len (rec/tot):    734/   734, tx:        505, lsn: 0/0168CE90, prev 0/0168CE48, desc: SPLIT_R level 0, firstright 368, newitemoff 408, blkref #0: rel 1663/16391/2659 blk 9, blkref #1: rel 1663/16391/2659 blk 10
rmgr: Btree       len (rec/tot):     61/   273, tx:        505, lsn: 0/0168D170, prev 0/0168CE90, desc: INSERT_UPPER off 9, blkref #0: rel 1663/16391/2659 blk 3 FPW, blkref #1: rel 1663/16391/2659 blk 9
rmgr: Heap        len (rec/tot):     54/  4694, tx:        505, lsn: 0/0168D288, prev 0/0168D170, desc: INSERT off 19 flags 0x00, blkref #0: rel 1663/16391/2610 blk 3 FPW
rmgr: Btree       len (rec/tot):     53/  3313, tx:        505, lsn: 0/0168E4F8, prev 0/0168D288, desc: INSERT_LEAF off 161, blkref #0: rel 1663/16391/2678 blk 1 FPW
rmgr: Btree       len (rec/tot):     53/  3313, tx:        505, lsn: 0/0168F1F0, prev 0/0168E4F8, desc: INSERT_LEAF off 161, blkref #0: rel 1663/16391/2679 blk 1 FPW
rmgr: Heap        len (rec/tot):     54/  1990, tx:        505, lsn: 0/0168FEE8, prev 0/0168F1F0, desc: INSERT off 4 flags 0x00, blkref #0: rel 1663/16391/2606 blk 0 FPW
rmgr: Btree       len (rec/tot):     53/   173, tx:        505, lsn: 0/016906C8, prev 0/0168FEE8, desc: INSERT_LEAF off 4, blkref #0: rel 1663/16391/2579 blk 1 FPW
rmgr: Btree       len (rec/tot):     53/   237, tx:        505, lsn: 0/01690778, prev 0/016906C8, desc: INSERT_LEAF off 3, blkref #0: rel 1663/16391/2664 blk 1 FPW
rmgr: Btree       len (rec/tot):     53/   253, tx:        505, lsn: 0/01690868, prev 0/01690778, desc: INSERT_LEAF off 4, blkref #0: rel 1663/16391/2665 blk 1 FPW
rmgr: Btree       len (rec/tot):     53/   173, tx:        505, lsn: 0/01690968, prev 0/01690868, desc: INSERT_LEAF off 2, blkref #0: rel 1663/16391/2666 blk 1 FPW
rmgr: Btree       len (rec/tot):     53/   173, tx:        505, lsn: 0/01690A18, prev 0/01690968, desc: INSERT_LEAF off 4, blkref #0: rel 1663/16391/2667 blk 1 FPW
rmgr: Heap        len (rec/tot):     80/    80, tx:        505, lsn: 0/01690AC8, prev 0/01690A18, desc: INSERT off 133 flags 0x00, blkref #0: rel 1663/16391/2608 blk 55
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/01690B18, prev 0/01690AC8, desc: INSERT_LEAF off 228, blkref #0: rel 1663/16391/2673 blk 32
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/01690B60, prev 0/01690B18, desc: INSERT_LEAF off 154, blkref #0: rel 1663/16391/2674 blk 41
rmgr: Heap        len (rec/tot):     80/    80, tx:        505, lsn: 0/01690BA8, prev 0/01690B60, desc: INSERT off 134 flags 0x00, blkref #0: rel 1663/16391/2608 blk 55
rmgr: Btree       len (rec/tot):     72/    72, tx:        505, lsn: 0/01690BF8, prev 0/01690BA8, desc: INSERT_LEAF off 225, blkref #0: rel 1663/16391/2673 blk 32
rmgr: Btree       len (rec/tot):     53/  6609, tx:        505, lsn: 0/01690C40, prev 0/01690BF8, desc: INSERT_LEAF off 219, blkref #0: rel 1663/16391/2674 blk 27 FPW
rmgr: XLOG        len (rec/tot):     49/   129, tx:        505, lsn: 0/01692630, prev 0/01690C40, desc: FPI , blkref #0: rel 1663/16391/24584 blk 0 FPW
rmgr: Heap        len (rec/tot):    188/   188, tx:        505, lsn: 0/016926B8, prev 0/01692630, desc: INPLACE off 4, blkref #0: rel 1663/16391/1259 blk 0
rmgr: Heap        len (rec/tot):    188/   188, tx:        505, lsn: 0/01692778, prev 0/016926B8, desc: INPLACE off 5, blkref #0: rel 1663/16391/1259 blk 0
rmgr: Transaction len (rec/tot):    645/   645, tx:        505, lsn: 0/01692838, prev 0/01692778, desc: COMMIT 2025-02-20 10:35:10.626244 UTC; inval msgs: catcache 50 catcache 49 catcache 50 catcache 49 catcache 50 catcache 49 catcache 7 catcache 6 catcache 32 catcache 19 catcache 75 catcache 74 catcache 75 catcache 74 catcache 50 catcache 49 catcache 7 catcache 6 catcache 7 catcache 6 catcache 7 catcache 6 catcache 7 catcache 6 catcache 7 catcache 6 catcache 7 catcache 6 catcache 7 catcache 6 relcache 24581 relcache 24584 relcache 24584 relcache 24581 snapshot 2608 snapshot 2608 relcache 24581
rmgr: Heap        len (rec/tot):     59/    59, tx:        506, lsn: 0/01692AC0, prev 0/01692838, desc: INSERT+INIT off 1 flags 0x00, blkref #0: rel 1663/16391/24581 blk 0
rmgr: Btree       len (rec/tot):     94/    94, tx:        506, lsn: 0/01692B00, prev 0/01692AC0, desc: NEWROOT lev 0, blkref #0: rel 1663/16391/24584 blk 1, blkref #2: rel 1663/16391/24584 blk 0
rmgr: Btree       len (rec/tot):     64/    64, tx:        506, lsn: 0/01692B60, prev 0/01692B00, desc: INSERT_LEAF off 1, blkref #0: rel 1663/16391/24584 blk 1
rmgr: Transaction len (rec/tot):     34/    34, tx:        506, lsn: 0/01692BA0, prev 0/01692B60, desc: COMMIT 2025-02-20 10:35:14.493157 UTC
rmgr: Heap        len (rec/tot):     59/    59, tx:        507, lsn: 0/01692BC8, prev 0/01692BA0, desc: INSERT off 2 flags 0x00, blkref #0: rel 1663/16391/24581 blk 0
rmgr: Btree       len (rec/tot):     64/    64, tx:        507, lsn: 0/01692C08, prev 0/01692BC8, desc: INSERT_LEAF off 2, blkref #0: rel 1663/16391/24584 blk 1
rmgr: Transaction len (rec/tot):     34/    34, tx:        507, lsn: 0/01692C48, prev 0/01692C08, desc: COMMIT 2025-02-20 10:35:14.495388 UTC
rmgr: Heap        len (rec/tot):     59/    59, tx:        508, lsn: 0/01692C70, prev 0/01692C48, desc: INSERT off 3 flags 0x00, blkref #0: rel 1663/16391/24581 blk 0
rmgr: Btree       len (rec/tot):     64/    64, tx:        508, lsn: 0/01692CB0, prev 0/01692C70, desc: INSERT_LEAF off 3, blkref #0: rel 1663/16391/24584 blk 1
rmgr: Transaction len (rec/tot):     34/    34, tx:        508, lsn: 0/01692CF0, prev 0/01692CB0, desc: COMMIT 2025-02-20 10:35:15.262640 UTC
rmgr: Heap        len (rec/tot):     59/    59, tx:        509, lsn: 0/01692D18, prev 0/01692CF0, desc: INSERT off 4 flags 0x00, blkref #0: rel 1663/16391/24581 blk 0
rmgr: Btree       len (rec/tot):     64/    64, tx:        509, lsn: 0/01692D58, prev 0/01692D18, desc: INSERT_LEAF off 4, blkref #0: rel 1663/16391/24584 blk 1
rmgr: Heap        len (rec/tot):     59/    59, tx:        509, lsn: 0/01692D98, prev 0/01692D58, desc: INSERT off 5 flags 0x00, blkref #0: rel 1663/16391/24581 blk 0
rmgr: Btree       len (rec/tot):     64/    64, tx:        509, lsn: 0/01692DD8, prev 0/01692D98, desc: INSERT_LEAF off 5, blkref #0: rel 1663/16391/24584 blk 1
rmgr: Heap        len (rec/tot):     59/    59, tx:        509, lsn: 0/01692E18, prev 0/01692DD8, desc: INSERT off 6 flags 0x00, blkref #0: rel 1663/16391/24581 blk 0
rmgr: Btree       len (rec/tot):     64/    64, tx:        509, lsn: 0/01692E58, prev 0/01692E18, desc: INSERT_LEAF off 6, blkref #0: rel 1663/16391/24584 blk 1
rmgr: Transaction len (rec/tot):     34/    34, tx:        509, lsn: 0/01692E98, prev 0/01692E58, desc: COMMIT 2025-02-20 10:35:24.261098 UTC
rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/01692EC0, prev 0/01692E98, desc: RUNNING_XACTS nextXid 510 latestCompletedXid 509 oldestRunningXid 510
rmgr: Heap        len (rec/tot):     54/    54, tx:        510, lsn: 0/01692EF8, prev 0/01692EC0, desc: DELETE off 1 flags 0x00 KEYS_UPDATED , blkref #0: rel 1663/16391/24581 blk 0
rmgr: Heap        len (rec/tot):     54/    54, tx:        510, lsn: 0/01692F30, prev 0/01692EF8, desc: DELETE off 2 flags 0x00 KEYS_UPDATED , blkref #0: rel 1663/16391/24581 blk 0
rmgr: Heap        len (rec/tot):     54/    54, tx:        510, lsn: 0/01692F68, prev 0/01692F30, desc: DELETE off 3 flags 0x00 KEYS_UPDATED , blkref #0: rel 1663/16391/24581 blk 0
rmgr: Transaction len (rec/tot):     34/    34, tx:        510, lsn: 0/01692FA0, prev 0/01692F68, desc: ABORT 2025-02-20 10:35:32.644745 UTC
[postgres@postdb01 pg_wal]$
```

```
pg_basebackup -D /var/lib/pgsql/12/backups -U postgres -Xs -Fp -P
cd /var/lib/pgsql/12/backups/pg_wal
waldump

```
