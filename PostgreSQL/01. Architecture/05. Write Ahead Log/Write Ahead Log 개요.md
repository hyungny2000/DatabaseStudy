## Write Ahead Log 개요

#### 어떤 장애 시나리오
DB에 데이터를 Update할 때, Shared Buffer에 있는 해당 버퍼를 찾아 Update쿼리를 수행하고 commit한다. commit만으로 사용자 입장에선 Update작업이 완료되었고, 이 이후로 변경된 데이터는 영구히 저장되어야 한다. 하지만 방금 작업했던 버퍼는 아직 디스크에 Flush되지 않은 Dirty한 상태로, 디스크 상의 페이지는 Update쿼리 실행하기 전의 과거 버전의 데이터를 가지고 있다. 이 순간 어떤 이유에서건 서버가 재부팅된다면 Shared Buffer에 있던 버퍼의 Update내용은 사라지게 되고, 데이터는 손실된다.

#### Write Ahead Log의 필요성
지인에게 큰 돈을 빌릴 때 차용증을 작성하고 대출을 받는다. 나중에 돈 떼일 때를 대비하여 법적 증거로 제시하기 위해서다. 마찬가지로, 데이터베이스도 데이터 변경, 신규 입력하기 전(Write Ahead)에 **데이터를 어떻게 변경했는지**를 로그로 항상 기록하고 데이터를 변경한다.     
만일 위 시나리오에서 Update 전에 WAL로그를 남겼다면, 서버가 재부팅되어서 디스크의 페이지에 과거 데이터만 남았다고 하더라도 재부팅 전 작업이력이 WAL Segment파일에서 작업로그를 가져와 데이터 페이지에 적용하기만 하면 복원할 수 있다. 트랜잭션의 Duration(영속성)을 이렇게 보장할 수 있다.

#### WAL의 용도
- Crash Recovery시 복구용도 : 위와 같이 서버가 비정상종료된 장애가 발생 후, DB기동할 때 WAL Log의 내용을 과거 버전의 데이터 페이지에 적용시켜가며 종료 직전의 데이터를 복구하는 작업을 **Crash Recovery**라고 한다.
- Media Recovery시 복구용도 : Media Recovery란 데이터파일이 손상된 상황에서의 복구를 말한다. 예를 들어 오늘 자정에 백업을 받았고, 오늘 오전 9시경 누군가의 실수로 운영 데이터파일을 모조리 삭제했다고 가정한다. 대략적인 복구 과정은 다음과 같다.
  - 오늘 자정에 받은 백업을 데이터 디렉토리로 옮긴다. (restore)
  - 오늘 자정부터 오전 9시까지의 작업이력(WAL Log)을 순서대로 적용해 가며 DB를 복구한다. (recovery)     
  이와 같이 Media Recovery시에도 복구용도로 매우 중요하다.
- 이중화 구성 시 : 마스터DB에서의 변경이력은 WAL로그로 기록된 다음, 스탠바이DB로 전송되어 그대로 적용하는 방식으로 동기화를 구현한다. 이중화 방식마다 WAL로그의 전달방식은 차이가 있겠지만, 변경이력을 스탠바이DB로 전송하는 수단이 WAL인 것은 동일하다.
