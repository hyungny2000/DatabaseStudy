## 논리적 스토리지 구조

#### Database
- 테이블, 인덱스를 비롯한 DB오브젝트들의 논리적 집합.
- 주로 서비스 단위로 나눈다.
- base 서브디렉토리에 저장된다.

#### Database Cluster
- PostgreSQL에서 Database Cluster는 위에서 이야기한 Database의 집합을 말한다.
- 다른 DBMS에서 말하는 물리적 DB서버 장비들의 집합이 아니다.
- initdb 명령을 통해 Database Cluster를 초기화하며, 이렇게 생성된 파일과 서브디렉토리들의 집합을 **데이터디렉토리** 라고 한다.
- 데이터디렉토리의 경로는 $PGDATA 환경변수로 지정하여 사용한다.

#### Tablespace 
- base서브디렉토리 외의  데이터파일들의 저장공간을 말한다.
- pg_tblspc 서브디렉토리 내에 심볼릭 링크로 생성되며, 심볼릭 링크는 테이블스페이스 생성시 지정된 경로와 연결된다.
- 데이터디렉토리보다 더 넓거나 더 빠른 스토리지를 사용하고 싶을 때 사용한다.

#### Schema
- 테이블, 인덱스 등의 DB오브젝트를 묶는 개념으로 사용되며, 데이터베이스의 하위개념이다.
- 기본값으로 public스키마가 있다.
- 관련 파라미터 : search_pattern

<br><br>
## 물리적 스토리지 구조

#### 데이터파일
- 테이블, 인덱스의 데이터를 물리적으로 저장하는 파일이다.
- 데이터파일은 한 테이블, 인덱스 당 세 가지가 있다.
  - 데이터파일 : 테이블, 인덱스 등의 데이터 페이지(Page)를 저장한다.
  - VM : Visibility Map의 준말로, 각 페이지 별 Visibility를 저장한다. vm으로 끝난다.
  - FSM : Free Space Mapping의 준말로, 각 페이지 별 Free Space정보를 저장한다. fsm으로 끝난다.

#### 페이지 (Page)
- 데이터파일을 구성하는 단위로, DB에서 메모리와 디스크 간 입출력을 위한 최소단위이다.
다시 말하면, 쿼리에서 단 한 줄만 읽더라도 한 페이지(Page)를 읽어야 한다는 뜻이다.
- 페이지는 여러 개의 튜플(Tuple)로 구성된다.
- 크기는 8192 Bytes로 고정적이다.
- 페이지의 구성요소
  - 페이지 헤더
    - pd_lsn : 가장 마지막에 변경완료된 WAL의 Log Sequence Number.
    - pd_checksum : 체크섬
    - pd_lower : 가장 마지막 Line Pointer
    - pd_upper : 맨 처음 Heap Tuple
    - pd_special : 인덱스에 관한 정보
 - 라인포인터 : 힙 튜플을 가리키는 인덱스. 페이지 헤더와 라인포인터까지는 페이지 상단에서부터 쌓인다.
 - 힙 튜플 : 테이블 데이터 한 줄에 해당하는 데이터를 보유한다. 페이지 바닥에서부터 쌓인다.
 - FreeSpace : 마지막 라인포인터(pd_lower)부터 첫번째 힙 튜플(pd_upper) 사이의 빈 공간을 말한다.
   
#### 튜플 (Tuple)
- 힙 튜플(Heap Tuple)이라고도 불린다. 크기가 고정적이지 않고 자유롭기 때문에 Heap이 붙는 것 같다.
- 테이블 한 줄의 데이터와 그 튜플에 대한 트랜잭션 정보를 담고 있다.
- 튜플 구성요소
  - t_xmin : Insert시점의 TxID(트랜잭션ID)
  - t_xmax : Update/Delete시점의 TxID
  - t_cid : 트랜잭션 내 명령의 순번
  - t_ctid : TupleID (Page Index + TupleID)로서 튜플의 구분자를 가리킨다. Update시점에는 새 튜플의 TID를 가리키고, 그 외에는 자기 자신의 위치를 가리킨다.

#### WAL (Write Ahead Log) Segment file
- DB의 변경이력(Insert/Update/Delete,Alter문 등)을 순차적으로 기록해 놓은 파일.
- pg_wal 서브디렉토리에 생성됨
- 용도
  - Crash Recovery에서 WAL file 내용을 재적용(Replay)할 때 사용
  - Media Recovery에서 WAL file 내용을 재적용(Replay)할 때 사용
  - Replication 구조에서 마스터DB의 변경사항을 스탠바이DB에 전달
