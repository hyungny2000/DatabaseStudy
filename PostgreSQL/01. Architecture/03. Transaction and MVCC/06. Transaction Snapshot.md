## Transaction Snapshot

#### Transaction Snapshot
```
SELECT * FROM txid_current_snapshot(); -- v12까지
SELECT * FROM pg_current_snapshot(); --13v부터

txid_current_snapshot
____ ____ ____________
 xmin:xmax:xip
```
- 현재 시점에 진행중인 트랜잭션의 시작XID(XMIN)정보를 스냅샷 형태로 받는다.
- XMIN : 현재 진행중인 가장 오래된 현재진행형 트랜잭션의 시작XID
- XMAX : 현재 진행중인 가장 늦게 시작된 현재진행형 트랜잭션의 시작XID
- XIP : XMIN ~ XMAX 사이의 현재 진행중인 트랜잭션들의 XID목록. (콤마로 구분)

#### Transaction Snapshot 해석
- XMIN 트랜잭션ID보다 작은 트랜잭션ID는 모두 Visible한 데이터로 간주함.
- XMAX 트랜잭션ID와 같거나 큰 트랜잭션ID는 모두 Invisible한 데이터로 간주함.
- XIP는 현재진행형(In Progress)한 트랜잭션ID이므로 Invisible한 데이터로 간주함.
- 예를 들어 Transaction Snapshot이 다음과 같다고 하자.
  ```
  100:105:101,102,104
  ```
   - 현재 진행중인 트랜잭션의 ID는 100번, 101번, 102번, 104번, 105번이고, 이 트랜잭션의 데이터는 Invisible하다.
   - XMIN=100번이므로 100보다 작은 트랜잭션은 Visible함.
   - XMAX=105번이므로 105와 같거나 큰 트랜잭션은 Invisible함.

#### MVCC와 Visibility
- MVCC : Multi Version Consistency Control (다중 버전 동시성 제어)의 약자로, 동일한 테이블의 동일한 데이터라 할지라도 트랜잭션의 고립레벨(Isolation Level)과 트랜잭션을 언제 시작했는지(트랜잭션ID)에 따라 볼 수 있는(Visible) 버전의 데이터와 볼 수 없는 (Invisible) 버전의 데이터가 존재한다. 트랜잭션 별로 볼 수 있는 데이터 버전을 구분하는 개념과 매커니즘을 MVCC라고 하며, 해당 데이터 버전을 볼 수 있는지 없는지를 따지는 개념을 Visibility라고 한다. (Visibility는 PostgreSQL에서만 사용하는 단어로 보인다.)
- 간단한 예시로, Read Committed 레벨에서는, 커밋되지 않은 데이터는 다른 트랜잭션에서 조회, 변경이 불가능하다.

#### Transaction Snapshot 테스트
1. Session 4개를 열어 각각 아래 명령을 실행한다.
  - Session#1 
  ```
  \set autocommit off;
  SELECT txid_current();
  begin;
  insert into test1 values (1);
  ```
  - Session#2 
  ```
  \set autocommit off;
  begin;
  SELECT txid_current();
  insert into test1 values (2);
  ```

  - Session#3 
  ```
  \set autocommit off;
  SELECT txid_current();
  begin;
  insert into test1 values (3);
  ```

  - Session#4
  ```
  \set autocommit off;
  SELECT txid_current();
  begin;
  insert into test1 values (4);
  ```

  | Session#1 | 568 |
  | --- | --- |
  | Session#2 | 570 |
  | Session#3 | 571 | 
  | Session#4 | 573 | 

  #### Read Committed 트랜잭션에서의 스냅샷 조회
  새 cmd창을 열어 DB접속 후 아래와 같이 조회한다.
  ```
  begin;
  SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
  select txid_current_snapshot();
   txid_current_snapshot
  -----------------------
   569:574:569,570,572
  ```

  #### Repeatable Read 트랜잭션에서의 스냅샷 조회
  새 cmd창을 열어 DB접속 후 아래와 같이 조회한다.
  ```
  begin;
  SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
  select txid_current_snapshot();
   txid_current_snapshot
  -----------------------
   569:574:569,570,572
  ```

  #### Session#2 커밋
  ```
  commit;
  ```

  #### Read Committed 트랜잭션에서의 스냅샷 조회
  ```
  nano=# select txid_current_snapshot();
   txid_current_snapshot
  -----------------------
   569:575:569,570,572
  (1 row)
  nano=# select * from test1;
  col1
  ------
      4
  (1 row)
  ```
#### Repeatable Read 트랜잭션에서의 스냅샷 조회
```
nano=# select txid_current_snapshot();
 txid_current_snapshot
-----------------------
 569:574:569,570,572

  nano=# select * from test1;
  col1
  ------
  (0 rows)
```

#### Session#3 커밋
  ```
  commit;
  ```

#### Read Committed 트랜잭션에서의 스냅샷 조회
```
nano=# select txid_current_snapshot();
 txid_current_snapshot
-----------------------
 569:575:569,570

 nano=# select * from test1;
 col1
------
    3
    4
(2 rows)
```

#### Repeatable Read 트랜잭션에서의 스냅샷 조회
```
nano=# select txid_current_snapshot();
 txid_current_snapshot
-----------------------
 569:574:569,570,572
(1 row)

nano=# select * from test1;
 col1
------
(0 rows)
```

#### Session#1 커밋
```
commit;
```

#### Read Committed 트랜잭션에서의 스냅샷 조회
```
nano=# select txid_current_snapshot();
 txid_current_snapshot
-----------------------
 570:575:570
(1 row)

nano=# select * from test1;
 col1
------
    1
    3
    4
(3 rows)
```

#### Repeatable Read 트랜잭션에서의 스냅샷 조회
```
nano=# select txid_current_snapshot();
 txid_current_snapshot
-----------------------
 569:574:569,570,572
(1 row)

nano=# select * from test1;
 col1
------
(0 rows)

```

#### Session#2 커밋
```
commit;
```

#### Read Committed 트랜잭션에서의 스냅샷 조회
```
nano=# select txid_current_snapshot();
 txid_current_snapshot
-----------------------
 575:575:
(1 row)

nano=# select * from test1;
 col1
------
    1
    2
    3
    4
(4 rows)
```

#### Repeatable Read 트랜잭션에서의 스냅샷 조회
```
nano=# select txid_current_snapshot();
 txid_current_snapshot
-----------------------
 569:574:569,570,572
(1 row)

nano=# select * from test1;
 col1
------
(0 rows)
```
