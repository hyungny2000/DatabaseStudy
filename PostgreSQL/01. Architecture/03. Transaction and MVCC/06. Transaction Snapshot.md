## Transaction Snapshot

#### Transaction Snapshot
```
SELECT * FROM txid_current_snapshot(); -- v12까지
SELECT * FROM pg_current_snapshot(); --13v부터

txid_current_snapshot
____ ____ ____________
 xmin:xmax:xip
```
- 현재 시점에 진행중인 트랜잭션의 시작XID(XMIN)정보를 스냅샷 형태로 받는다.
- XMIN : 현재 진행중인 가장 오래된 현재진행형 트랜잭션의 시작XID
- XMAX : 현재 진행중인 가장 늦게 시작된 현재진행형 트랜잭션의 시작XID
- XIP : XMIN ~ XMAX 사이의 현재 진행중인 트랜잭션들의 XID목록. (콤마로 구분)

#### Transaction Snapshot 해석
- XMIN 트랜잭션ID보다 작은 트랜잭션ID는 모두 Visible한 데이터로 간주함.
- XMAX 트랜잭션ID와 같거나 큰 트랜잭션ID는 모두 Invisible한 데이터로 간주함.
- XIP는 현재진행형(In Progress)한 트랜잭션ID이므로 Invisible한 데이터로 간주함.
- 예를 들어 Transaction Snapshot이 다음과 같다고 하자.
  ```
  100:105:101,102,104
  ```
 - 현재 진행중인 트랜잭션의 ID는 100번, 101번, 102번, 104번, 105번이고, 이 트랜잭션의 데이터는 Invisible하다.
 - XMIN=100번이므로 100보다 작은 트랜잭션은 Visible함.
 - XMAX=105번이므로 105와 같거나 큰 트랜잭션은 Invisible함.

#### MVCC와 Visibility
- MVCC : Multi Version Consistency Control (다중 버전 동시성 제어)의 약자로, 동일한 테이블의 동일한 데이터라 할지라도 트랜잭션의 고립레벨(Isolation Level)과 트랜잭션을 언제 시작했는지(트랜잭션ID)에 따라 볼 수 있는(Visible) 버전의 데이터와 볼 수 없는 (Invisible) 버전의 데이터가 존재한다. 트랜잭션 별로 볼 수 있는 데이터 버전을 따지는 개념을 Visibility라고 한다.
- 간단한 예시로, Read Committed 레벨에서는, 커밋되지 않은 데이터는 다른 트랜잭션에서 조회, 변경이 불가능하다.

| XID | 트랜잭션#1 | 트랜잭션#2 |
| --- | --- | --- |
| 100 | begin; | |
| | insert into test1 (col1) values (1); | |
| 101 |   | begin;
|     |   | select * from test1 where col1=1; |
|     |   | -> no row selected |
|     | commit; | |
|     |    | select *  from test1 where col1=1; |
|      |    | -> 1 (1 row selected) |
- 트랜잭션#1 (XID = 100)의 insert쿼리가 진행중인 상태이며, Insert데이터는 버퍼 내의 힙 튜플로 등록되어 있다.
- 트랜잭션#2 (XID = 101)의 delete문은 진행중인 트랜잭션이 Insert한 데이터가 버퍼 내에 있었음에도, 진행중인 트랜잭션의 데이터는 Invisible하므로 Select에 실패한다.
- 이후 트랜잭션#1이 commit;하고 비활성 상태가 되자 비로소 트랜잭션#2에선 Insert데이터가 Visible한 상태가 되었고, Select에 성공한다.
