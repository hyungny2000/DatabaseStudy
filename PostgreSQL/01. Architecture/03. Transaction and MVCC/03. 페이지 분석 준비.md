# 페이지 분석 준비
## pageinspect 확장

#### 참고자료
- [postgrespro.com](https://postgrespro.com/docs/postgresql/9.4/pageinspect)
- [PostgreSQL12 매뉴얼](https://www.postgresql.org/docs/12/pageinspect.html)

#### 용도
- 매우 낮은 수준의 페이지 정보를 확인하는 용도

#### 설치
```
create extension pageinspect
```
- 데이터베이스 생성시, 해당 데이터베이스에 접속해서 설치해야 한다.

#### 기능
###### 페이지 헤더 정보 조회
```
SELECT * FROM page_header(get_raw_page('pg_class', 0));
```
- 테이블명, 페이지 번호로 조회

###### 페이지 튜플 정보 조회
```
SELECT * FROM heap_page_items(get_raw_page('pg_class', 0));
```

###### 페이지에 있는 인덱스 튜플 정보 조회
```
SELECT * FROM bt_page_items('pg_class', 0);
```
- 테이블명, 페이지 번호로 조회

#### 테스트

###### 빈 테이블 (test1) 생성 후 페이지 정보 조회
```
nano=# create table test1 (col1 int primary key);
nano=# SELECT * FROM page_header(get_raw_page('test1','main', 0));
ERROR:  block number 0 is out of range for relation "test1"

[postgres@postdb01 16412]$ ls -rlht | grep 24576
-rw------- 1 postgres postgres    0 Feb 19 23:25 24576
```
- 테이블 생성하고 조회하면 조회할 블록이 없어 에러가 남. 파일 크기가 0이므로 읽을 페이지가 없는 거지.

###### test1 테이블에 데이터 1건건 insert 후 페이지 정보 조회
```
nano=# insert into test1 values (1);
INSERT 0 1
nano=# exit
[postgres@postdb01 16412]$ ls -rlt | grep 24576
-rw------- 1 postgres postgres   8192 Feb 19 23:31 24576

nano=# SELECT * FROM page_header(get_raw_page('test1','main', 0));
    lsn    | checksum | flags | lower | upper | special | pagesize | version | prune_xid
-----------+----------+-------+-------+-------+---------+----------+---------+-----------
 0/16D8428 |        0 |     0 |    28 |  8160 |    8192 |     8192 |       4 |         0
(1 row)

nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |   t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+------------
  1 |   8160 |        1 |     28 |    492 |      0 |        0 | (0,1)  |           1 |       2048 |     24 |        |       | \x01000000
(1 row)

```
- 데이터 1건 insert 후 데이터파일에 페이지 할당되어 8192바이트 증가.
- 페이지 헤더 조회결과 제대로 나오는 듯 함.
- 데이터 1건에 대한 튜플 정보 출력 완료

###### test1 테이블에 데이터 1건 추가 insert 후 페이지 정보 조회
```
nano=# insert into test1 values (2);
INSERT 0 1
nano=# SELECT * FROM page_header(get_raw_page('test1','main', 0));
    lsn    | checksum | flags | lower | upper | special | pagesize | version | prune_xid
-----------+----------+-------+-------+-------+---------+----------+---------+-----------
 0/16D8568 |        0 |     0 |    32 |  8128 |    8192 |     8192 |       4 |         0
(1 row)

nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |   t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+------------
  1 |   8160 |        1 |     28 |    492 |      0 |        0 | (0,1)  |           1 |       2048 |     24 |        |       | \x01000000
  2 |   8128 |        1 |     28 |    493 |      0 |        0 | (0,2)  |           1 |       2048 |     24 |        |       | \x02000000
(2 rows)
```

###### test1 테이블에 update 1건 실행 후 페이지 정보 조회
```
nano=# update test1 set col1=3 where col1=1;
UPDATE 1
nano=# SELECT * FROM page_header(get_raw_page('test1','main', 0));
    lsn    | checksum | flags | lower | upper | special | pagesize | version | prune_xid
-----------+----------+-------+-------+-------+---------+----------+---------+-----------
 0/16D87B8 |        0 |     0 |    36 |  8096 |    8192 |     8192 |       4 |       494
(1 row)

nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |   t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+------------
  1 |   8160 |        1 |     28 |    492 |    494 |        0 | (0,3)  |        8193 |        256 |     24 |        |       | \x01000000
  2 |   8128 |        1 |     28 |    493 |      0 |        0 | (0,2)  |           1 |       2048 |     24 |        |       | \x02000000
  3 |   8096 |        1 |     28 |    494 |      0 |        0 | (0,3)  |           1 |      10240 |     24 |        |       | \x03000000
(3 rows)
```

## infomask 해석을 위한 함수 생성
