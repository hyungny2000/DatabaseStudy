## 페이지와 튜플 구조

#### 페이지 구조
<img src="./img/Page구조.png" width=600/>

```
nano=# SELECT * FROM page_header(get_raw_page('test1','main', 0));
    lsn    | checksum | flags | lower | upper | special | pagesize | version | prune_xid
-----------+----------+-------+-------+-------+---------+----------+---------+-----------
 0/16D8428 |        0 |     0 |    28 |  8160 |    8192 |     8192 |       4 |         0
```
- pd_lsn : 마지막 트랜잭션의 Log Sequence Number(WAL Buffer상의 트랜잭션 로그의 위치)
- pd_checksum : 데이터 무결성 체크를 위한 체크섬 문자열
- pd_lower : 마지막 lp의 위치
- pd_upper : 처음 Heap Tuple의 위치.
- pd_special : 인덱스 페이지에 사용되는 정보
- Line Pointer(lp) : 라인포인터, Heap Tuple의 Offset 정보 보유. 페이지 위에서부터 쌓임.
- Heap Tuple : 실제적인 데이터와 데이터와 연관된 트랜잭션ID정보 보관. 페이지 밑바닥부터 쌓임.
- Free Space : 페이지의 여유공간. 라인포인터 마지막(pd_lower)과 맨 위의 힙튜플(pd_upper)의 중간의 빈공간을 의미함.

#### 튜플의 구조 ([소스 링크](https://github.com/postgres/postgres/blob/REL_12_STABLE/src/include/access/htup_details.h))
<img src="./img/htuple.png" width=600/>

```
nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |   t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+------------
  1 |   8160 |        1 |     28 |    492 |      0 |        0 | (0,1)  |           1 |       2048 |     24 |        |       | \x01000000
```
- lp : 라인포인터. 힙 튜플의 오프셋 정보 보유.
- t_xmin : insert시점의 트랜잭션ID
- t_xmax : update, delete 시점의 트랜잭션ID (Commit/Rollback과는 관련이 없음)
- t_ctid : 해당 튜플의 위치 (Tuple ID = Page index + linepointer index (offset))
- t_cid : 트랜잭션 내에서의 명령 순번. 예를 들어 해당 튜플이 begin 이후 두 번째 명령에서 변경되었다면 2가 입력된다.
- t_infomask : 16진수 4자리수로(2진수 16비트) 이루어진 플래그이다. 주로 해당 튜플의 commit/rollback여부, frozen 등 내부로직처리에 필요한 속성을 담고 있다.
- t_infomask2 : 튜플과 관련된 기타 정보(속성 수, HOT여부 등)과 연관된 정보를 담고 있다.
- userdata : 실제적인 데이터이다.

#### infomask 각 마스킹 비트 별 설명
| 16진수 | 이진 비트 | 소스 상 정의 | 설명 | 
| --- | --- | --- | --- |
| 0x0001 | 0000000000000001 | HEAP_HASNULL | 해당 튜플에 Null값을 가진 속성이 존재함 |
| 0x0002 | 0000000000000010 | HEAP_HASVARWIDTH | 가변길이 속성을 포함 |
| 0x0004 | 0000000000000100 | HEAP_H플 구조 (lp=4)
- t_xmin : Update시점의 트랜잭션ID 521기록
- t_xmax : 아직 Update/delete 작업이 없으므로 0
- t_ctid : 자기 위치표시
- t_infomask2 : 1이므로 속성 1개임을 의미
- t_infomask : 10240(0010 1000 00000000), HEAP_UPDATED, HEAP_XMAX_INVALID상태로 Update된 튜플, 즉 Update쿼리로 인해 Insert된 튜플임을 뜻하는 듯 하다. T_XMAX값은 유효하지 않다는 의미.

#### autocommit off, begin ~ commit 블록 내에서 Insert쿼리 3번 실행
```
nano=# \set autocommit off;
nano=# begin;
BEGIN
nano=# insert into test1 values (5);
INSERT 0 1
nano=# insert into test1 values (6);
INSERT 0 1
nano=# insert into test1 values (7);
INSERT 0 1
nano=# commit;
COMMIT
nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |   t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+------------
  1 |   8160 |        1 |     28 |    517 |    520 |        0 | (0,1)  |        8193 |        256 |     24 |        |       | \x01000000
  2 |   8128 |        1 |     28 |    518 |    521 |        0 | (0,4)  |        8193 |        256 |     24 |        |       | \x02000000
  3 |   8096 |        1 |     28 |    519 |      0 |        0 | (0,3)  |           1 |       2048 |     24 |        |       | \x03000000
  4 |   8064 |        1 |     28 |    521 |      0 |        0 | (0,4)  |           1 |      10240 |     24 |        |       | \x04000000
  5 |   8032 |        1 |     28 |    522 |      0 |        0 | (0,5)  |           1 |       2048 |     24 |        |       | \x05000000
  6 |   8000 |        1 |     28 |    522 |      0 |        1 | (0,6)  |           1 |       2048 |     24 |        |       | \x06000000
  7 |   7968 |        1 |     28 |    522 |      0 |        2 | (0,7)  |           1 |       2048 |     24 |        |       | \x07000000
```
- lp값 5,6,7번의 t_xmin값이 522로 모두 동일함. 같은 begin ~ commit; 내에 있어서 하나의 트랜잭션에서 동작했음을 의미한다.
- 5,6,7번의 t_field3값이 0,1,2로 되어 있어 begin ~ commit; 내의 실행순서를 표시한다.

