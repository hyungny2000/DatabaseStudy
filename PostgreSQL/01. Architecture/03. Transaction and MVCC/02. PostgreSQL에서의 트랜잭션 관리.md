## PostgreSQL에서의 트랜잭션 관리

#### Txid (Transaction ID)
- 트랜잭션 시작 시 트랜잭션 매니저로부터 부여받는 일련번호.
- 트랜잭션이 거듭되면서 1씩 증가하므로
  - 숫자가 작을 수록 과거버전
  - 숫자가 클 수록 미래버전
- 32비트 (8바이트)의 unsigned integer 형으로, 최대값은 약 42억 정도 된다.
- 예약된 TxID
  - 0 : 쓰지 않는 TxID
  - 1 : 부트스트랩TxID. initdb시점에 사용됨
  - 2 : Frozen TxID. PostgreSQL 9.5 이전 버전에선 Vacuum Freeze시에 2로 설정함
  - 3 : 일반적인 TxID.
- 현재 TxID 조회방법
  ```
  postgres=# SELECT txid_current();
  txid_current 
  --------------
             737
  ```

#### TxID Wraparound
- TxID는 3부터 42억까지 증가하는 일련번호이므로, 언젠가는 반드시 42억(정확히는 2^32 = 4,294,967,296)에 도달하게 된다.
- TxID가 2^32를 넘어서면 다시 3부터 시작하게 되면, **실제 2^32는 3보다 과거시점이지만 2^32가 숫자가 커서 미래시점으로 간주되어 보이지 않게 되어 데이터가 손실된다.** 이 현상을 TxID Wraparound현상이라고 한다.

#### Autovacuum Daemon
- 이 이상현상을 막기 위해 Vacuum을 통해 트랜잭션 ID를 주기적으로 Freezing한다.
- 위 사례에서 만약 2^32가 Frozen상태라면, 현재 TxID가 3 정도로 아무리 작아도 2^32(Frozen XID)보다는 미래시점으로 간주된다.

#### Commit Log
- 현재진행형 트랜잭션 현황을 기록하는 메모리 영역

#### 힙 튜플의 xmin, xmax 상태 모니터링
- 힙 튜플 헤더에 해당 튜플을 Insert/Update/Delete한 트랜잭션과 그 트랜잭션 상태에 대한 단서가 있음
  - XMIN : 튜플을 Insert한 트랜잭션의 ID
    - XMIN_COMMITTED, XMIN_INVALID : XMIN트랜잭션의 COMMIT/ROLLBACK 여부
  - XMAX : 튜플을 Update/Delete한 트랜잭션의 ID
    - XMAX_COMMITTED, XMAX_INVALID : XMAX트랜잭션의 COMMIT/ROLLBACK 여부
- 이 정보들을 참고하여 각 트랜잭션 별로 해당 튜플의 데이터를 보여줄지 말지를 결정하게 됨.

#### Transaction Snapshot
- 조회하는 현재 시점에서 진행중인 트랜잭션의 XID를 보여줌.
- 힙 튜플의 헤더정보와 함께 해당 튜플의 데이터를 보여줄지 말지를 결정하게 됨.
