## PostgreSQL에서의 트랜잭션 관리

#### XID (Transaction ID)
- 트랜잭션 시작 시 트랜잭션 매니저로부터 부여받는 일련번호로, 트랜잭션 시작할 때마다 1씩 증가하므로 모든 트랜잭션의 XID는 같을 수 없다.
- 32비트 (8바이트)의 unsigned integer 형으로, 최대값은 2의 32승으로 약 42억 9천만 정도 된다.
- 예약된 XID
  - 0 : 쓰지 않는 XID
  - 1 : 부트스트랩 XID. initdb시점에 사용됨
  - 2 : Frozen XID. PostgreSQL 9.5 이전 버전에선 Vacuum Freeze시에 2로 설정함
  - 3 : 일반적인 XID.
- 현재 XID 조회방법
  ```
  postgres=# SELECT txid_current();
  txid_current 
  --------------
             737
  ```
#### XID 사용 용도
1. 트랜잭션을 구분하기 위한 용도이다.
2. 트랜잭션이 거듭되면서 XID는 1씩 증가한다. 자연히 숫자가 작을 수록 과거, 숫자가 클 수록 미래버전이 되므로 어떤 트랜잭션이 어떤 데이터 버전을 볼 수 있는지를 다음과 같이 판단하게 해준다.
  - XID가 100인 트랜잭션에서는 XID가 100보다 큰 데이터는 미래 버전으로 볼 수 없다.
  - XID가 100인 트랜잭션에서는 XID가 100보다 작은 데이터는 과거 버전이므로 볼 수 있다.

#### XID Wraparound
- XID는 3부터 42억까지 증가하는 일련번호이므로, 언젠가는 반드시 42억(정확히는 2^32 = 4,294,967,296)에 도달하게 된다.
- XID가 2^32를 넘어서면 예약된 XID인 0,1,2가 아닌 3부터 시작하게 되는데, 이렇게 되면 **실제 2^32는 Wraparound된 3보다 과거시점이지만 2^32가 숫자가 커서 미래시점으로 간주되어 보이지 않게 되어 데이터가 손실된다.** 이 현상을 XID Wraparound현상이라고 한다.

#### VACUUM FREEZE
- 이 이상현상을 막기 위해 Vacuum을 통해 오래된 트랜잭션 ID를 주기적으로 Freezing한다.
- 위 사례에서 만약 2^32가 Frozen상태라면, 현재 XID가 3 정도로 아무리 작아도 2^32(Frozen XID)보다는 미래시점으로 간주된다.
- 9.6버전 이후부터는 XMIN값을 2로 바꾸는 대신, 튜플 헤더에 XMIN_FROZEN 비트를 설정하여 FREEZING한다. 원래의 XMIN값을 보존하기 위함이다.
- 자세한 사항은 VACUUM단원을 참고하자.

#### Commit Log
- 현재진행형 트랜잭션 현황을 기록하는 메모리 영역

#### 힙 튜플 헤더의 xmin, xmax 상태 플래그
- 힙 튜플 헤더에 해당 튜플을 Insert/Update/Delete한 트랜잭션ID와 그 트랜잭션의 Commit/Rollback여부를 가지고 있음.
  - XMIN : 튜플을 Insert한 트랜잭션의 ID
    - XMIN_COMMITTED, XMIN_INVALID : XMIN트랜잭션의 COMMIT/ROLLBACK 여부
  - XMAX : 튜플을 Update/Delete한 트랜잭션의 ID
    - XMAX_COMMITTED, XMAX_INVALID : XMAX트랜잭션의 COMMIT/ROLLBACK 여부
- 이 정보들을 참고하여 각 트랜잭션 별로 해당 튜플의 데이터를 보여줄지 말지를 결정하게 됨.

#### Transaction Snapshot
- 조회하는 현재 시점에서 진행중인 트랜잭션의 XID를 보여줌.
- 힙 튜플의 헤더정보와 함께 해당 튜플의 데이터를 보여줄지 말지를 결정하게 됨.
