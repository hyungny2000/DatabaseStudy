## 페이지의 구조

#### 페이지 구조
<img src="./img/Page구조.png" width=600/>

```
nano=# SELECT * FROM page_header(get_raw_page('test1','main', 0));
    lsn    | checksum | flags | lower | upper | special | pagesize | version | prune_xid
-----------+----------+-------+-------+-------+---------+----------+---------+-----------
 0/16D8428 |        0 |     0 |    28 |  8160 |    8192 |     8192 |       4 |         0
```
- pd_lsn : 마지막 트랜잭션의 Log Sequence Number
- pd_checksum : 데이터 무결성 체크를 위한 체크섬 문자열
- pd_lower : 마지막 lp의 위치
- pd_upper : 처음 Heap Tuple의 위치
- Line Pointer(lp) : 라인포인터, Heap Tuple의 Offset 정보 보유
- Heap Tuple : 실제적인 데이터와 데이터와 연관된 트랜잭션ID정보 보관
- Free Space : 페이지의 여유공간

#### Heap Tuple의 구조
<img src="./img/htuple.png" width=600/>

```
nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |   t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+------------
  1 |   8160 |        1 |     28 |    492 |      0 |        0 | (0,1)  |           1 |       2048 |     24 |        |       | \x01000000
```
- lp : 라인포인터
- t_xmin : insert시점의 트랜잭션ID
- t_xmax : update, delete 시점의 트랜잭션ID (Commit/Rollback과는 관련이 없음)
- t_ctid : 해당 튜플의 위치 (Tuple ID = Page index + linepointer index (offset))
- t_cid : 트랜잭션 내에서의 명령 순번. 예를 들어 해당 튜플이 begin 이후 두 번째 명령에서 변경되었다면 2가 입력된다.
- t_infomask : 16진수 4비트로 이루어진 플래그이다. 주로 해당 튜플의 commit/rollback여부, frozen 등 내부로직처리에 필요한 정보를 담고 있다.
- t_infomask2 : 주로 multi transaction과 연관된 정보를 담고 있다.
- userdata : 실제적인 데이터이다.

#### 빈 테이블의 페이지 조회
```
nano=# truncate table test1;
TRUNCATE TABLE
nano=# SELECT * FROM page_header(get_raw_page('test1','main', 0));
ERROR:  block number 0 is out of range for relation "test1"
nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
ERROR:  block number 0 is out of range for relation "test1"
```

#### Insert 수행 시 페이지 구조
```
nano=# insert into test1 values (1);
INSERT 0 1
nano=# SELECT * FROM page_header(get_raw_page('test1','main', 0));
    lsn    | checksum | flags | lower | upper | special | pagesize | version | prune_xid
-----------+----------+-------+-------+-------+---------+----------+---------+-----------
 0/50038F0 |        0 |     0 |    28 |  8160 |    8192 |     8192 |       4 |         0
(1 row)

nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |   t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+------------
  1 |   8160 |        1 |     28 |    517 |      0 |        0 | (0,1)  |           1 |       2048 |     24 |        |       | \x01000000

nano=# insert into test1 values (2);
INSERT 0 1
nano=# insert into test1 values (3);
INSERT 0 1
nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |   t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+------------
  1 |   8160 |        1 |     28 |    517 |      0 |        0 | (0,1)  |           1 |       2048 |     24 |        |       | \x01000000
  2 |   8128 |        1 |     28 |    518 |      0 |        0 | (0,2)  |           1 |       2048 |     24 |        |       | \x02000000
  3 |   8096 |        1 |     28 |    519 |      0 |        0 | (0,3)  |           1 |       2048 |     24 |        |       | \x03000000
(3 rows)
```
- 1번 데이터는 트랜잭션 ID 517번에 튜플 오프셋은 0,1임. 2,3번도 마찬가지
- atocommit on이므로 매 insert시마다 commit되었으므로, 세 insert문의 트랜잭션은 제각각이고, 각각 트랜잭션ID를 하나씩 받았음.

#### 1번 데이터 Delete 후 페이지 구조
```
nano=# delete from test1 where col1 = 1;
DELETE 1
nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |   t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+------------
  1 |   8160 |        1 |     28 |    517 |    520 |        0 | (0,1)  |        8193 |        256 |     24 |        |       | \x01000000
  2 |   8128 |        1 |     28 |    518 |      0 |        0 | (0,2)  |           1 |       2048 |     24 |        |       | \x02000000
  3 |   8096 |        1 |     28 |    519 |      0 |        0 | (0,3)  |           1 |       2048 |     24 |        |       | \x03000000
(3 rows)

nano=# SELECT lp, t_xmin, t_xmax, t_infomask::bit(16) as t_infomask, t_data FROM heap_page_items(get_raw_page('test1', 0));
 lp | t_xmin | t_xmax |    t_infomask    |   t_data
----+--------+--------+------------------+------------
  1 |    517 |    520 | 0000000100000000 | \x01000000
  2 |    518 |      0 | 0000100000000000 | \x02000000
  3 |    519 |      0 | 0000100000000000 | \x03000000
```
- 1번 데이터 delete시점의 트랜잭션 ID가 520번임(t_xmax)
- 1번 데이터의 t_infomask가 0000000100000000임. 분석 필요

#### 2번 데이터 Update 후 페이지 구조
```
nano=# update test1 set col1=4 where col1=2;
UPDATE 1
nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |   t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+------------
  1 |   8160 |        1 |     28 |    517 |    520 |        0 | (0,1)  |        8193 |        256 |     24 |        |       | \x01000000
  2 |   8128 |        1 |     28 |    518 |    521 |        0 | (0,4)  |        8193 |        256 |     24 |        |       | \x02000000
  3 |   8096 |        1 |     28 |    519 |      0 |        0 | (0,3)  |           1 |       2048 |     24 |        |       | \x03000000
  4 |   8064 |        1 |     28 |    521 |      0 |        0 | (0,4)  |           1 |      10240 |     24 |        |       | \x04000000
(4 rows)

nano=# SELECT lp, t_xmin, t_xmax, t_infomask::bit(16) as t_infomask, t_data FROM heap_page_items(get_raw_page('test1', 0));
 lp | t_xmin | t_xmax |    t_infomask    |   t_data
----+--------+--------+------------------+------------
  1 |    517 |    520 | 0000000100000000 | \x01000000
  2 |    518 |    521 | 0000000100000000 | \x02000000
  3 |    519 |      0 | 0000100000000000 | \x03000000
  4 |    521 |      0 | 0010100000000000 | \x04000000
(4 rows)
```
- 2번 데이터의 t_xmax에 update시점의 트랜잭션ID인 521로 표시됨.
- 2번 데이터의 위치정보(t_ctid)가 새 튜플의 위치인 (0,4)를 가리키고 있음.

#### autocommit off, begin ~ commit 블록 내에서 Insert쿼리 3번 실행
```
nano=# \set autocommit off;
nano=# begin;
BEGIN
nano=# insert into test1 values (5);
INSERT 0 1
nano=# insert into test1 values (6);
INSERT 0 1
nano=# insert into test1 values (7);
INSERT 0 1
nano=# commit;
COMMIT
nano=# SELECT * FROM heap_page_items(get_raw_page('test1', 0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |   t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+------------
  1 |   8160 |        1 |     28 |    517 |    520 |        0 | (0,1)  |        8193 |        256 |     24 |        |       | \x01000000
  2 |   8128 |        1 |     28 |    518 |    521 |        0 | (0,4)  |        8193 |        256 |     24 |        |       | \x02000000
  3 |   8096 |        1 |     28 |    519 |      0 |        0 | (0,3)  |           1 |       2048 |     24 |        |       | \x03000000
  4 |   8064 |        1 |     28 |    521 |      0 |        0 | (0,4)  |           1 |      10240 |     24 |        |       | \x04000000
  5 |   8032 |        1 |     28 |    522 |      0 |        0 | (0,5)  |           1 |       2048 |     24 |        |       | \x05000000
  6 |   8000 |        1 |     28 |    522 |      0 |        1 | (0,6)  |           1 |       2048 |     24 |        |       | \x06000000
  7 |   7968 |        1 |     28 |    522 |      0 |        2 | (0,7)  |           1 |       2048 |     24 |        |       | \x07000000
(7 rows)

nano=# SELECT lp, t_xmin, t_xmax, t_infomask::bit(16) as t_infomask, t_data FROM heap_page_items(get_raw_page('test1', 0));
 lp | t_xmin | t_xmax |    t_infomask    |   t_data
----+--------+--------+------------------+------------
  1 |    517 |    520 | 0000000100000000 | \x01000000
  2 |    518 |    521 | 0000000100000000 | \x02000000
  3 |    519 |      0 | 0000100000000000 | \x03000000
  4 |    521 |      0 | 0010100000000000 | \x04000000
  5 |    522 |      0 | 0000100000000000 | \x05000000
  6 |    522 |      0 | 0000100000000000 | \x06000000
  7 |    522 |      0 | 0000100000000000 | \x07000000
(7 rows)

nano=#
```
- 5,6,7번의 t_xmin값이 522로 모두 동일함. 같은 begin ~ commit; 내에 있어서 하나의 트랜잭션에서 동작했음을 의미한다.


