## Visibility Rule

#### 참고자료
- [interdb.jp](https://www.interdb.jp/pg/pgsql05/06.html)

#### Visibility Rule
어떤 트랜잭션에 어떤 데이터가 보여야 할지 말아야 할지의 개념은 Visibility, Visibility를 결정하는 규칙을 PostgreSQL에서는 Visibility Rule이라고 한다. Visibility Rule에서 참고하는 데이터는 다음과 같다.
- 트랜잭션 스냅샷 : 현재진행형 트랜잭션ID를 식별하는 자료
- 해당 튜플의 XMIN, XMAX 상태 플래그 : 해당 튜플을 생성, 변경했던 XMIN,XMAX 트랜잭션의 상태정보.

#### 의사 코드
- 실제 컴파일되는 코드는 아니고, 사람이 이해하기 위해 만드는 코드
- XMIN_INVALID, XMIN_COMMITTED, XMAX_INVALID, XMAX_COMMITTED : 튜플 헤더의 XMIN, XMAX 트랜잭션 상태 정보
  - XMIN_INVALID = TRUE : XMIN트랜잭션이 INVALID하다는 뜻.
  - XMIN_COMMITTED = TRUE : XMIN트랜잭션이 COMMIT했다는 뜻.
- TXSLOT_INPROGRESS() : 트랜잭션 슬롯에서 트랜잭션이 현재진행형일 경우 TRUE, 아니면 FALSE
- txid_current() : 현재 트랜잭션ID 확인
```
IF(XMIN_INVALID == TRUE)
    RETURN 'INVISIBLE'; -- XMIN트랜잭션이 ROLLBACK되었으므로 보아서는 안됨.
ELSE
    IF(TXSLOT_INPROGRESS(XMIN) == TRUE) -- XMIN 트랜잭션이 현재진행형
        IF(XMIN == txid_current())
            RETURN 'VISIBLE'; -- 현재 트랜잭션에서 작업중이라면 봐야 함
        ELSE
            RETURN 'INVISIBLE'; -- 다른 트랜잭션에서 진행중인 작업은 보아서는 안됨.
    ELSE IF(XMIN_COMMITTED == TRUE) -- XMIN트랜잭션이 COMMIT된 상태
        IF(TXSLOT_INPROGRESS(XMIN) == TRUE) -- XMIN트랜잭션이 현재진행형이면 보여서는 안된다. (Repeatable Read를 기억하라)
            RETURN 'INVISIBLE'
        ELSE IF(XMAX_INVALID == TRUE)
            RETURN 'VISIBLE'; -- XMAX트랜잭션이 ROLLBACK되었으므로 봐야 함.
        ELSE IF(TXSLOT_INPROGRESS(XMAX) = TRUE)
            IF(XMAX == txid_current())
                RETURN 'VISIBLE'; -- XMAX트랜잭션이 현재진행형이어도, 현재 트랜잭션의 변경사항이면 봐야 함.
            ELSE
                RETURN 'INVISIBLE'; -- XMAX트랜잭션이 다른 트랜잭션이며 현재진행형이면 보면 안됨
        ELSE IF (XMAX_COMMITTED == TRUE)
            IF(TXSLOT_INPROGRESS(XMAX) == TRUE)
                RETURN 'VISIBLE'; -- XMAX트랜잭션이 COMMIT되었고, XMAX트랜잭션이 현재진행형이면 봐야함.
            ELSE
                RETURN 'INVISIBLE'; -- XMAX트랜잭션이 COMMIT되었고, XMAX트랜잭션이 종료되었으면 안봐야 함.
            END
        END
    END       
END
```

