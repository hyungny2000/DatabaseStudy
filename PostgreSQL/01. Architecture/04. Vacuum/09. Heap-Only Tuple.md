# Heap-Only Tuple
## 개념
### 정의
- 테이블 update는 Update가 아닌 Insert & Delete 방식
- 인덱스 데이터를 Update하지 않을 때도 Insert & Delete 방식으로 동작하면 인덱스 크기가 매우 커질 것.
- 인덱스 데이터가 Update되지 않을 때, 인덱스 튜플이 아닌 테이블의 튜플만 Insert & Delete되는 방식을 Heap Only Tuple이라고 한다.

### 제약
- 테이블 update할 때, 구 버전 튜플과 신규 버전 튜플이 동일한 페이지에 존재할 때에만 HOT가 동작한다.

## 테스트
1. test1 테이블(PK인덱스 포함) 생성, 데이터 1건 입력
   ```
   create table test1 (col1 int primary key, col2 int) with (fillfactor=10);
   insert into test1 values (1, 2);
   ```

2. test1 테이블 및 test1_pkey 인덱스 페이지 상태 조회
   ```
   [테이블 튜플 정보]
   SELECT lp, t_xmin, t_xmax, t_ctid, t_infomask2::bit(16)
         ,b'0100000000000000' & t_infomask2::bit(16) = b'0100000000000000' as HEAP_HOT_UPDATED
         ,b'1000000000000000' & t_infomask2::bit(16) = b'1000000000000000' as HEAP_ONLY_TUPLE
         ,age(t_xmin), t_data
   FROM heap_page_items(get_raw_page('test1', 0));
   lp|t_xmin|t_xmax|t_ctid|t_infomask2     |heap_hot_updated|heap_only_tuple|age|t_data  |
   --+------+------+------+----------------+----------------+---------------+---+--------+
    1|7164  |0     |(0,1) |0000000000000010|false           |false          |  1|        |

   [인덱스 튜플 정보]
   itemoffset|ctid |itemlen|nulls|vars |data                   |
   ----------+-----+-------+-----+-----+-----------------------+
            1|(0,1)|     16|false|false|01 00 00 00 00 00 00 00|
   ```
   - 테이블 튜플 정보
     - HEAP_HOT_UPDATED : UPDATE로 인해 HOT UPDATED된 DEAD TUPLE의 상태
     - HEAP_ONLY_TUPLE : UPDATE로 인해 HOT상태로 생성된 튜플.
     - 현재는 위 플래그 둘 다 해당사항이 없음
    - 인덱스 튜플 정보
      - ctid : 대응되는 테이블의 TID(Tuple ID = pageIndex + offset)
      - data : 인덱스 데이터
        
3. test1 테이블 데이터 update 후 확인
    ```
   [update 쿼리 실행]
   update test1 set col2 = 3 where col1 = 1;

   [테이블 튜플 정보]
   lp|t_xmin|t_xmax|t_ctid|t_infomask2     |heap_hot_updated|heap_only_tuple|age|t_data  |
   --+------+------+------+----------------+----------------+---------------+---+--------+
    1|7164  |7165  |(0,2) |0100000000000010|true            |false          |  2|        |
    2|7165  |0     |(0,2) |1000000000000010|false           |true           |  1|        |

   [인덱스 튜플 정보]
   itemoffset|ctid |itemlen|nulls|vars |data                   |
   ----------+-----+-------+-----+-----+-----------------------+
            1|(0,1)|     16|false|false|01 00 00 00 00 00 00 00|
   ```
   - 테이블 튜플 정보 변경
     - (0,1)튜플 : XMIN, XMAX COMMIT상태로 Dead Tuple임. HEAP_HOT_UPDATED상태이므로 (0,2)튜플을 찾아가야 함.
     - (0,2)튜플 : Update쿼리로 인해 신규생성된 최신버전 튜플. HEAP_ONLY_TUPLE상태이므로, 인덱스에선 없음
   -인덱스 튜플 정보 : 테이블의 (0,1)튜플을 바라보고 있음.

4. update 재시도 후 확인
   ```
   [update 쿼리 실행]
   update test1 set col2 = 4 where col1 = 1; -- col1 데이터 다시 update

   [테이블 튜플 정보]
   lp|t_xmin|t_xmax|t_ctid|t_infomask2     |heap_hot_updated|heap_only_tuple|age|t_data  |
   --+------+------+------+----------------+----------------+---------------+---+--------+
    1|7164  |7165  |(0,2) |0100000000000010|true            |false          |  3|        |
    2|7165  |7166  |(0,3) |1100000000000010|true            |true           |  2|        |
    3|7166  |0     |(0,3) |1000000000000010|false           |true           |  1|        |

   [인덱스 튜플 정보]
   itemoffset|ctid |itemlen|nulls|vars |data                   |
   ----------+-----+-------+-----+-----+-----------------------+
            1|(0,1)|     16|false|false|01 00 00 00 00 00 00 00|
   ```
   - 테이블 튜플 정보 변경
     - (0,2)튜플 : XMIN, XMAX COMMIT상태로 Dead Tuple임. HEAP_HOT_UPDATED상태이므로 (0,3)튜플을 찾아가야 함.
     - (0,3)튜플 : Update쿼리로 인해 신규생성된 최신버전 튜플. HEAP_ONLY_TUPLE상태이므로, 인덱스에선 없음
   - 인덱스 튜플 정보 : 테이블의 (0,1)튜플을 바라보고 있음. (변동 없음)
   - **인덱스 튜플 -> 테이블(0,1)튜플 -> 테이블 (0,2)튜플 -> 테이블 (0,3)튜플로 이어지는 연결고리를 HOT Chain**이라고 함.
  
5. update 20번 반복실행 후 확인
   ```
   update test1 set col2 = 4 where col1 = 1; ---- 20회 반복복

   [테이블 튜플 정보]
   lp|t_xmin|t_xmax|t_ctid|t_infomask2     |heap_hot_updated|heap_only_tuple|age|t_data  |
   --+------+------+------+----------------+----------------+---------------+---+--------+
    1|7164  |7165  |(0,2) |0100000000000010|true            |false          | 23|        |
    2|7165  |7166  |(0,3) |1100000000000010|true            |true           | 22|        |
    3|7166  |7167  |(0,4) |1100000000000010|true            |true           | 21|        |
    4|7167  |7168  |(0,5) |1100000000000010|true            |true           | 20|        |
    5|7168  |7169  |(0,6) |1100000000000010|true            |true           | 19|        |
    6|7169  |7170  |(0,7) |1100000000000010|true            |true           | 18|        |
    7|7170  |7171  |(0,8) |1100000000000010|true            |true           | 17|        |
    8|7171  |7172  |(0,9) |1100000000000010|true            |true           | 16|        |
    9|7172  |7173  |(0,10)|1100000000000010|true            |true           | 15|        |
   10|7173  |7174  |(0,11)|1100000000000010|true            |true           | 14|        |
   11|7174  |7175  |(0,12)|1100000000000010|true            |true           | 13|        |
   12|7175  |7176  |(0,13)|1100000000000010|true            |true           | 12|        |
   13|7176  |7177  |(0,14)|1100000000000010|true            |true           | 11|        |
   14|7177  |7178  |(0,15)|1100000000000010|true            |true           | 10|        |
   15|7178  |7179  |(0,16)|1100000000000010|true            |true           |  9|        |
   16|7179  |7180  |(0,17)|1100000000000010|true            |true           |  8|        |
   17|7180  |7181  |(0,18)|1100000000000010|true            |true           |  7|        |
   18|7181  |7182  |(0,19)|1100000000000010|true            |true           |  6|        |
   19|7182  |7183  |(0,20)|1100000000000010|true            |true           |  5|        |
   20캔

   [테이블 튜플 정보]
   lp|t_xmin|t_xmax|t_ctid|t_infomask2     |heap_hot_updated|heap_only_tuple|age|t_data  |
   --+------+------+------+----------------+----------------+---------------+---+--------+
    1|      |      |      |                |                |               |   |        |
    2|      |      |      |                |                |               |   |        |
    3|      |      |      |                |                |               |   |        |
    4|      |      |      |                |                |               |   |        |
    5|      |      |      |                |                |               |   |        |
    6|      |      |      |                |                |               |   |        |
    7|      |      |      |                |                |               |   |        |
    8|      |      |      |                |                |               |   |        |
    9|      |      |      |                |                |               |   |        |
   10|      |      |      |                |                |               |   |        |
   11|      |      |      |                |                |               |   |        |
   12|      |      |      |                |                |               |   |        |
   13|      |      |      |                |                |               |   |        |
   14|      |      |      |                |                |               |   |        |
   15|      |      |      |                |                |               |   |        |
   16|      |      |      |                |                |               |   |        |
   17|      |      |      |                |                |               |   |        |
   18|      |      |      |                |                |               |   |        |
   19|      |      |      |                |                |               |   |        |
   20|      |      |      |                |                |               |   |        |
   21|      |      |      |                |                |               |   |        |
   22|      |      |      |                |                |               |   |        |
   23|7186  |0     |(0,23)|1000000000000010|false           |true           |  1|        |

   [인덱스 튜플 정보]
   itemoffset|ctid |itemlen|nulls|vars |data                   |
   ----------+-----+-------+-----+-----+-----------------------+
            1|(0,1)|     16|false|false|01 00 00 00 00 00 00 00|
   ```
   - 페이지 내의 여유공간이 부족하다고 판단되면, select로 테이블을 스캔하는 시점에 dead tuple을 정리함으로써 HOT Chain이 길어지지 않게 관리한다.
     -  vacuum없이 Dead tuple을 정리하는 과정 자체를 **Single Page Vacuum**이라고 한다.
     -  Single Page Vacuum으로 HOT Chain을 정리하는 과정을 **HOT Chain Pruning**이라고 한다.
   - 인덱스 페이지 정보는 그대로다(?). 그럼 어떻게 찾아가지?
  
