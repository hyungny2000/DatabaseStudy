# Heap-Only Tuple
## 개념
### 정의
- 테이블 update는 Update가 아닌 Insert & Delete 방식
- 인덱스 데이터 Update될 때도 테이블과 마찬가지로 Insert & Delete 방식으로 동작함.
- 테이블 Update시, 인덱스 데이터를 Update하지 않을 때도 Insert & Delete 방식으로 동작하면 인덱스 크기가 매우 커질 것.
- 인덱스 데이터가 Update되지 않을 때, 인덱스 튜플이 아닌 테이블의 튜플만 Insert & Delete되는 방식을 Heap Only Tuple이라고 한다.

### HOT Chain
- 테이블 Update시 다음 현상이 발생한다. MVCC단원에 자세히 설명했으니, 여기선 간단히 짚고 넘어간다.
  - 구 버전 튜플의 CTID는 신규 버전의 TID(Tuple ID = PageIndex + offset)으로 대체된다.
  - 신규 버전 튜플은 CTID는 자기 자신의 TID가 된다.
- 이처럼 구 버전 튜플의 CTID가 다음 버전 튜플의 TID를 가리킨다.
- Update가 거듭되면서 위 과정이 반복, 구 버전 튜플과 다음 버전 튜플 간의 연결고리가 계속 길어지는데 이를 HOT Chain이라고 한다.

### Single Page Vacuum
- 페이지의 여유공간이 부족하다고 여겨지면, **vacuum이 동작하지 않아도 페이지 스캔 시점에 dead tuple을 정리한다.** 이를 Single Page Vacuum이라고 한다.
- **dead tuple이 정리되면서, 자연스럽게 HOT Chain이 짧아지는데**, 이를 HOT Chain Pruning이라고 한다.

### 제약
- 테이블 데이터를 update할 때, 구 버전 튜플과 신규 버전 튜플이 동일한 페이지에 존재할 때에만 HOT가 동작한다.

## 테스트
1. test1 테이블(PK인덱스 포함) 생성, 데이터 1건 입력
   ```
   create table test1 (col1 int primary key, col2 int) with (fillfactor=10);
   insert into test1 values (1, 2);
   ```

2. test1 테이블 및 test1_pkey 인덱스 페이지 상태 조회
   ```
   [테이블 튜플 정보]
   SELECT lp, lp_off, lp_flags, t_xmin, t_xmax, t_ctid, t_infomask2::bit(16)
         ,b'0100000000000000' & t_infomask2::bit(16) = b'0100000000000000' as HEAP_HOT_UPDATED
         ,b'1000000000000000' & t_infomask2::bit(16) = b'1000000000000000' as HEAP_ONLY_TUPLE
         ,age(t_xmin), t_data
   FROM heap_page_items(get_raw_page('test1', 0));
   lp|lp_off|lp_flags|t_xmin|t_xmax|t_ctid|t_infomask2     |heap_hot_updated|heap_only_tuple|age|t_data  |
   --+------+--------+------+------+------+----------------+----------------+---------------+---+--------+
    1|  8160|       1|7190  |0     |(0,1) |0000000000000010|false           |false          |  1|        |

   [인덱스 튜플 정보]
   itemoffset|ctid |itemlen|nulls|vars |data                   |
   ----------+-----+-------+-----+-----+-----------------------+
            1|(0,1)|     16|false|false|01 00 00 00 00 00 00 00|
   ```
   - 테이블 튜플 정보
     - HEAP_HOT_UPDATED : UPDATE로 인해 HOT UPDATED된 DEAD TUPLE의 상태
     - HEAP_ONLY_TUPLE : UPDATE로 인해 HOT상태로 생성된 튜플.
     - 현재는 위 플래그 둘 다 해당사항이 없음
    - 인덱스 튜플 정보
      - ctid : 대응되는 테이블의 TID(Tuple ID = pageIndex + offset)
      - data : 인덱스 데이터
        
3. test1 테이블 데이터 update 후 확인
    ```
   [update 쿼리 실행]
   update test1 set col2 = 3 where col1 = 1;

   [테이블 튜플 정보]
   lp|lp_off|lp_flags|t_xmin|t_xmax|t_ctid|t_infomask2     |heap_hot_updated|heap_only_tuple|age|t_data  |
   --+------+--------+------+------+------+----------------+----------------+---------------+---+--------+
    1|  8160|       1|7190  |7191  |(0,2) |0100000000000010|true            |false          |  2|        |
    2|  8128|       1|7191  |0     |(0,2) |1000000000000010|false           |true           |  1|        |

   [인덱스 튜플 정보]
   itemoffset|ctid |itemlen|nulls|vars |data                   |
   ----------+-----+-------+-----+-----+-----------------------+
            1|(0,1)|     16|false|false|01 00 00 00 00 00 00 00|
   ```
   - 테이블 튜플 정보 변경
     - (0,1)튜플 : XMIN, XMAX COMMIT상태로 Dead Tuple임. HEAP_HOT_UPDATED상태이므로 (0,2)튜플을 찾아가야 함.
     - (0,2)튜플 : Update쿼리로 인해 신규생성된 최신버전 튜플. HEAP_ONLY_TUPLE상태이므로, 인덱스에선 없음
   -인덱스 튜플 정보 : 테이블의 (0,1)튜플을 바라보고 있음.

4. update 재시도 후 확인
   ```
   [update 쿼리 실행]
   update test1 set col2 = 4 where col1 = 1; -- col1 데이터 다시 update

   [테이블 튜플 정보]
   lp|lp_off|lp_flags|t_xmin|t_xmax|t_ctid|t_infomask2     |heap_hot_updated|heap_only_tuple|age|t_data  |
   --+------+--------+------+------+------+----------------+----------------+---------------+---+--------+
    1|  8160|       1|7190  |7191  |(0,2) |0100000000000010|true            |false          |  3|        |
    2|  8128|       1|7191  |7192  |(0,3) |1100000000000010|true            |true           |  2|        |
    3|  8096|       1|7192  |0     |(0,3) |1000000000000010|false           |true           |  1|        |

   [인덱스 튜플 정보]
   itemoffset|ctid |itemlen|nulls|vars |data                   |
   ----------+-----+-------+-----+-----+-----------------------+
            1|(0,1)|     16|false|false|01 00 00 00 00 00 00 00|
   ```
   - 테이블 튜플 정보 변경
     - (0,2)튜플 : XMIN, XMAX COMMIT상태로 Dead Tuple임. HEAP_HOT_UPDATED상태이므로 (0,3)튜플을 찾아가야 함.
     - (0,3)튜플 : Update쿼리로 인해 신규생성된 최신버전 튜플. HEAP_ONLY_TUPLE상태이므로, 인덱스에선 없음
   - 인덱스 튜플 정보 : 테이블의 (0,1)튜플을 바라보고 있음. (변동 없음)
   - **인덱스 튜플 -> 테이블(0,1)튜플 -> 테이블 (0,2)튜플 -> 테이블 (0,3)튜플로 이어지는 연결고리를 HOT Chain**이라고 함.
  
5. update 20번 반복실행 후 확인
   ```
   update test1 set col2 = 4 where col1 = 1; ---- 20회 반복

   [테이블 튜플 정보]
   lp|lp_off|lp_flags|t_xmin|t_xmax|t_ctid|t_infomask2     |heap_hot_updated|heap_only_tuple|age|t_data  |
   --+------+--------+------+------+------+----------------+----------------+---------------+---+--------+
    1|  8160|       1|7190  |7191  |(0,2) |0100000000000010|true            |false          | 23|        |
    2|  8128|       1|7191  |7192  |(0,3) |1100000000000010|true            |true           | 22|        |
    3|  8096|       1|7192  |7193  |(0,4) |1100000000000010|true            |true           | 21|        |
    4|  8064|       1|7193  |7194  |(0,5) |1100000000000010|true            |true           | 20|        |
    5|  8032|       1|7194  |7195  |(0,6) |1100000000000010|true            |true           | 19|        |
    6|  8000|       1|7195  |7196  |(0,7) |1100000000000010|true            |true           | 18|        |
    7|  7968|       1|7196  |7197  |(0,8) |1100000000000010|true            |true           | 17|        |
    8|  7936|       1|7197  |7198  |(0,9) |1100000000000010|true            |true           | 16|        |
    9|  7904|       1|7198  |7199  |(0,10)|1100000000000010|true            |true           | 15|        |
   10|  7872|       1|7199  |7200  |(0,11)|1100000000000010|true            |true           | 14|        |
   11|  7840|       1|7200  |7201  |(0,12)|1100000000000010|true            |true           | 13|        |
   12|  7808|       1|7201  |7202  |(0,13)|1100000000000010|true            |true           | 12|        |
   13|  7776|       1|7202  |7203  |(0,14)|1100000000000010|true            |true           | 11|        |
   14|  7744|       1|7203  |7204  |(0,15)|1100000000000010|true            |true           | 10|        |
   15|  7712|       1|7204  |7205  |(0,16)|1100000000000010|true            |true           |  9|        |
   16|  7680|       1|7205  |7206  |(0,17)|1100000000000010|true            |true           |  8|        |
   17|  7648|       1|7206  |7207  |(0,18)|1100000000000010|true            |true           |  7|        |
   18|  7616|       1|7207  |7208  |(0,19)|1100000000000010|true            |true           |  6|        |
   19|  7584|       1|7208  |7209  |(0,20)|1100000000000010|true            |true           |  5|        |
   20|  7552|       1|7209  |7210  |(0,21)|1100000000000010|true            |true           |  4|        |
   21|  7520|       1|7210  |7211  |(0,22)|1100000000000010|true            |true           |  3|        |
   22|  7488|       1|7211  |7212  |(0,23)|1100000000000010|true            |true           |  2|        |
   23|  7456|       1|7212  |0     |(0,23)|1000000000000010|false           |true           |  1|        |

   [인덱스 튜플 정보]
   itemoffset|ctid |itemlen|nulls|vars |data                   |
   ----------+-----+-------+-----+-----+-----------------------+
            1|(0,1)|     16|false|false|01 00 00 00 00 00 00 00|
   ```
   - HOT Chain이 (0,1) -> (0,2) -> .... -> (0,23)으로 매우 길어졌음.

6. test1 테이블 스캔 후 확인
   ```
   select count(*) from test1;
   
   [테이블 튜플 정보]
   lp|lp_off|lp_flags|t_xmin|t_xmax|t_ctid|t_infomask2     |heap_hot_updated|heap_only_tuple|age|t_data  |
   --+------+--------+------+------+------+----------------+----------------+---------------+---+--------+
    1|    23|       2|      |      |      |                |                |               |   |        |
    2|     0|       0|      |      |      |                |                |               |   |        |
    3|     0|       0|      |      |      |                |                |               |   |        |
    4|     0|       0|      |      |      |                |                |               |   |        |
    5|     0|       0|      |      |      |                |                |               |   |        |
    6|     0|       0|      |      |      |                |                |               |   |        |
    7|     0|       0|      |      |      |                |                |               |   |        |
    8|     0|       0|      |      |      |                |                |               |   |        |
    9|     0|       0|      |      |      |                |                |               |   |        |
   10|     0|       0|      |      |      |                |                |               |   |        |
   11|     0|       0|      |      |      |                |                |               |   |        |
   12|     0|       0|      |      |      |                |                |               |   |        |
   13|     0|       0|      |      |      |                |                |               |   |        |
   14|     0|       0|      |      |      |                |                |               |   |        |
   15|     0|       0|      |      |      |                |                |               |   |        |
   16|     0|       0|      |      |      |                |                |               |   |        |
   17|     0|       0|      |      |      |                |                |               |   |        |
   18|     0|       0|      |      |      |                |                |               |   |        |
   19|     0|       0|      |      |      |                |                |               |   |        |
   20|     0|       0|      |      |      |                |                |               |   |        |
   21|     0|       0|      |      |      |                |                |               |   |        |
   22|     0|       0|      |      |      |                |                |               |   |        |
   23|  8160|       1|7212  |0     |(0,23)|1000000000000010|false           |true           |  1|        |

   [인덱스 튜플 정보]
   itemoffset|ctid |itemlen|nulls|vars |data                   |
   ----------+-----+-------+-----+-----+-----------------------+
            1|(0,1)|     16|false|false|01 00 00 00 00 00 00 00|
   ```
   - 페이지 내의 여유공간이 부족하다고 판단되면, select로 테이블을 스캔하는 시점에 dead tuple을 정리함으로써 HOT Chain이 길어지지 않게 관리한다.
     -  vacuum없이 Dead tuple을 정리하는 과정 자체를 **Single Page Vacuum**이라고 한다.
     -  Single Page Vacuum으로 HOT Chain을 정리하는 과정을 **HOT Chain Pruning**이라고 한다.
     -  테이블 페이지내의 (0,1)튜플은 비록 vacuumed되었지만, **인덱스에서는 여전히 (0,1)튜플을 가리키므로 lp_off컬럼에 HOT의 offset을 남겨놓았다.**
   - **인덱스 튜플 -> 테이블(0,1)튜플 -> 테이블(0,23)튜플**로 HOT Chain이 짧아졌다.

7. vacuum full 후 확인.
   ```
   vacuum full test1;
 
   [테이블 튜플 정보]
   lp|lp_off|lp_flags|t_xmin|t_xmax|t_ctid|t_infomask2     |heap_hot_updated|heap_only_tuple|age|t_data  |
   --+------+--------+------+------+------+----------------+----------------+---------------+---+--------+
    1|  8160|       1|7212  |0     |(0,1) |0000000000000010|false           |false          |  2|        |
 
   [인덱스 튜플 정보]
   itemoffset|ctid |itemlen|nulls|vars |data                   |
   ----------+-----+-------+-----+-----+-----------------------+
            1|(0,1)|     16|false|false|01 00 00 00 00 00 00 00|
   ```
   - vacuum full명령으로 공간을 반환
   - 테이블 튜플 (0,23)이 (0,1)로 위치가 변경되었고, HEAP_ONLY_TUPLE값이 TRUE->FALSE로 변경되어 HOT가 아니게 됨.
