## Vacuum 관련 파라미터
vacuum과 관련한 파라미터를 잘 숙지해야 한다. 이해를 잘 못하고 설정하면 데이터가 손실될 수 있기 때문이다.

#### vacuum_freeze_min_age
얼마 이상 나이든(aged) 행을 Freezing할지 정하는 파라미터로, 이 값이 작을 수록 보다 자주, 이른 시점에 해당 튜플이 Frozen상태로 변환됨을 의미.    
###### 파라미터 값이 지나치게 작으면...
파라미터 값이 지나치게 작다는 말은 튜플이 생성된 지 얼마 지나지 않아 Frozen된다는 뜻이다. 예를 들어 **파라미터 값이 100으로 설정**되었다고 가정하고 다음 예시를 보자.
1. 보통 생성된 지 얼마 안된 튜플은 이른 시기에 수정/삭제될 가능성이 높다.
2. 파라미터 값이 100으로 설정되어 있으면, 생성된지 얼마 안된 튜플이 Frozen된다. 예를 들어 `insert into tab1 values ('PostgreSQL');`을 실행했다고 가정하자. 이 때 할당받은 XID는 100이다. 이후 얼마 되지 않아 Age(XMIN)=100이 되어 1번 튜플은 Frozen상태가 되었다.
   
   |LP| XMIN |XMAX |XMIN_FROZEN | DATA |
   | --- | --- | --- | --- | --- |
   | 1 | 100 | 0 | True | 'PostgreSQL' |
3. 곧이어 Frozen된 튜플이 `update tab1 set data='Good';`쿼리에 의해 Dead Tuple이 되고, 신규 버전의 튜플은 새 XID인 201을 할당받는다.

   |LP| XMIN |XMAX |XMIN_FROZEN | DATA |
   | --- | --- | --- | --- | --- |
   | 1 | 100 | 201 | True | 'PostgreSQL' |
   | 2 | 201 | 0  | False | 'Good' |
5. 추후 XMIN=201인 튜플도 Age대상이 되어 vacuum이 되면서 다음과 같이 된다. Dead Tuple은 제거되고, 2번 튜플이 Frozen되었다. 

   |LP| XMIN |XMAX |XMIN_FROZEN | DATA |
   | --- | --- | --- | --- | --- |
   | 1 |  |  |  |  |
   | 2 | 201 | 0  | True | 'Good' |
프로덕션DB에서 트랜잭션 100은 너무나 짧은 순간이다. 파라미터 값이 적당히 컸다면 최초 Insert된 튜플은 Frozen되지 않고 바로 삭제되어 Freezing횟수가 절반으로 줄어 서버 리소스의 낭비를 줄였을 것이다.

###### 파라미터 값이 지나치게 크다면
당연히 XID Wraparound가 발생하여 데이터 손실이 발생한다. 예시는 안들어도 될 듯 하다.

###### 권고값
ChatGPT에 따르면, 적당한 값은 100만 ~ 150만 정도라고 한다.

#### vacuum_freeze_min_age 테스트

1. VACUUM 테스트를 위해 XID를 원하는 만큼 소모시킬 프로시저 생성
   ```
   CREATE OR REPLACE PROCEDURE consume_transactions(num_tx BIGINT)
   LANGUAGE plpgsql
   AS $$
   DECLARE
       i BIGINT := 0;
   BEGIN
       -- 트랜잭션 소모를 위한 임시 테이블 생성
       CREATE TEMP TABLE IF NOT EXISTS xid_test (id SERIAL PRIMARY KEY, dummy TEXT);
   
       WHILE i < num_tx LOOP   
           BEGIN
               INSERT INTO xid_test (dummy) VALUES ('XID Test');  -- XID 소비
               COMMIT;  -- 트랜잭션 종료 후 새로운 XID 할당
               i := i + 1;
           EXCEPTION WHEN others THEN
               ROLLBACK;  -- 오류 발생 시 트랜잭션 롤백
           END;
       END LOOP;
   END $$;

   실행방법
   CALL consume_transactions(100000);
   ```
2. vacuum_freeze_min_age 값을 100으로 설정 후 재기동
   ```
   vi postgresql.conf

   vacuum_freeze_min_age = 100

   :wq

   pg_ctl restart
   ```

3. test1 테이블 생성, 데이터 입력 이후 페이지 상태 조회
   ```
   create table test1 (col1 int primary key);

   insert into test1 values(1);

   SELECT lp, t_xmin, t_xmax, t_ctid, t_infomask::bit(16)
           ,b'0000001100000000' & t_infomask::bit(16) = b'0000001100000000' as XMIN_FROZEN
           ,t_data
   FROM heap_page_items(get_raw_page('test1', 0));

   SELECT CTID, XMIN, XMAX, COL1 FROM test1;   
   ```

4. XID를 100만큼 소모
   ```
   CALL consume_transactions(100);
   ```

5. vacuum 실시 후 페이지 조회
   ```
   vacuum test1;

   SELECT lp, t_xmin, t_xmax, t_ctid, t_infomask::bit(16)
           ,b'0000001100000000' & t_infomask::bit(16) = b'0000001100000000' as XMIN_FROZEN
           ,t_data
   FROM heap_page_items(get_raw_page('test1', 0));

   SELECT CTID, XMIN, XMAX, COL1 FROM test1;
   ```

6. 데이터 Update실시 후 페이지 조회
   ```
   update test1 set col1=2 where col1=1;

   SELECT lp, t_xmin, t_xmax, t_ctid, t_infomask::bit(16)
           ,b'0000001100000000' & t_infomask::bit(16) = b'0000001100000000' as XMIN_FROZEN
           ,t_data
   FROM heap_page_items(get_raw_page('test1', 0));

   SELECT CTID, XMIN, XMAX, COL1 FROM test1;
   ```

7. XID를 100만큼 소모
   ```
   CALL consume_transactions(100);
   ```
8. vacuum 실시 후 페이지 조회
   ```
   vacuum test1;

   SELECT lp, t_xmin, t_xmax, t_ctid, t_infomask::bit(16)
           ,b'0000001100000000' & t_infomask::bit(16) = b'0000001100000000' as XMIN_FROZEN
           ,t_data
   FROM heap_page_items(get_raw_page('test1', 0));

   SELECT CTID, XMIN, XMAX, COL1 FROM test1;
   ```

#### vacuum_freeze_table_age
설정한 나이가 되면, 해당 테이블에 있는 모든 튜플을 Freeze하게 된다. vacuum_freeze_min_age가 튜플의 Age가 설정값을 넘기면 Freeze하는 튜플 단위 vacuum이라면, 이 파라미터는 
해당 테이블의 모든 튜플을 Freeze하는, 보다 공격적인 Freezing을 하게 된다.

#### vacuum_freeze_table_age 테스트

