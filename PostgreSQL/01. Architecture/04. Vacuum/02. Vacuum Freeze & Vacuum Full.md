## Vacuum Freeze & Vacuum Full
Vacuum 동작으로 어떻게 과거 버전의 튜플이 제거되는지 알아보자.

#### 테스트 방법
1. test1 테이블을 신규생성하거나, test1 테이블을 truncate한다.
   ```
   create table test1 (col1 int primary key);
   or
   truncate table test1;
   ```
3. 다음 DML을 진행한다. autocommit on 상태로 둔다.
   ```
   insert into test1 (col1) values (1);
   insert into test1 (col1) values (2);
   insert into test1 (col1) values (3);

   delete from test1 where col1 = 2;

   update test1 set col1 = 5 where col1 = 3;
   ```
4. vacuum 실행하기 전의 페이지 상태 및 데이터를 조회한다. (pageinspect 확장을 설치해야 한다.)
   ```
   SELECT lp, t_xmin, t_xmax, t_ctid, t_infomask::bit(16)
           ,b'0000001100000000' & t_infomask::bit(16) = b'0000001100000000' as XMIN_FROZEN
           ,t_data
   FROM heap_page_items(get_raw_page('test1', 0));

   SELECT CTID, XMIN, XMAX, COL1 FROM test;
   ```
5. test1에 대해 vacuum freeze 또는 vacuum full을 실행한다.
   ```
   vacuum freeze test1;
   vacuum full test1;
   ```
6. vacuum 실행 후 페이지 상태 및 데이터를 조회한다. 방법은 3번과 같다.

#### 테스트 결과
###### vacuum freeze 이전
```
nano=# SELECT lp, t_xmin, t_xmax, t_ctid, t_infomask::bit(16)
           ,b'0000001100000000' & t_infomask::bit(16) = b'0000001100000000' as XMIN_FROZEN
           ,t_data
   FROM heap_page_items(get_raw_page('test1', 0));
 lp | t_xmin | t_xmax | t_ctid |    t_infomask    | xmin_frozen |   t_data
----+--------+--------+--------+------------------+-------------+------------
  1 |    549 |      0 | (0,1)  | 0000100000000000 | f           | \x01000000
  2 |    550 |    552 | (0,2)  | 0000000100000000 | f           | \x02000000
  3 |    551 |    553 | (0,4)  | 0000000100000000 | f           | \x03000000
  4 |    553 |      0 | (0,4)  | 0010100000000000 | f           | \x05000000
(4 rows)

nano=#    SELECT CTID, XMIN, XMAX, COL1 FROM test1;
 ctid  | xmin | xmax | col1
-------+------+------+------
 (0,1) |  549 |    0 |    1
 (0,4) |  553 |    0 |    5
(2 rows)
```


###### vacuum freeze 이후
```
nano=# SELECT lp, t_xmin, t_xmax, t_ctid, t_infomask::bit(16)
           ,b'0000001100000000' & t_infomask::bit(16) = b'0000001100000000' as XMIN_FROZEN
           ,t_data
   FROM heap_page_items(get_raw_page('test1', 0));
 lp | t_xmin | t_xmax | t_ctid |    t_infomask    | xmin_frozen |   t_data
----+--------+--------+--------+------------------+-------------+------------
  1 |    549 |      0 | (0,1)  | 0000101100000000 | t           | \x01000000
  2 |        |        |        |                  |             |
  3 |        |        |        |                  |             |
  4 |    553 |      0 | (0,4)  | 0010101100000000 | t           | \x05000000
(4 rows)

nano=#    SELECT CTID, XMIN, XMAX, COL1 FROM test1;
 ctid  | xmin | xmax | col1
-------+------+------+------
 (0,1) |  549 |    0 |    1
 (0,4) |  553 |    0 |    5
(2 rows)
```
- 2,3번 튜플이 제거된 모습은 vacuum과 동일하다.
- 1,4번 튜플의 xmin_frozen 플래그가 True로 변경되었다. 해당 XID가 Freeze되었다는 의미이다.

###### vacuum full 이전
```
nano=# SELECT lp, t_xmin, t_xmax, t_ctid, t_infomask::bit(16)
           ,b'0000001100000000' & t_infomask::bit(16) = b'0000001100000000' as XMIN_FROZEN
           ,t_data
   FROM heap_page_items(get_raw_page('test1', 0));
 lp | t_xmin | t_xmax | t_ctid |    t_infomask    | xmin_frozen |   t_data
----+--------+--------+--------+------------------+-------------+------------
  1 |    556 |      0 | (0,1)  | 0000100000000000 | f           | \x01000000
  2 |    557 |    559 | (0,2)  | 0000000100000000 | f           | \x02000000
  3 |    558 |    560 | (0,4)  | 0000000100000000 | f           | \x03000000
  4 |    560 |      0 | (0,4)  | 0010100000000000 | f           | \x05000000
(4 rows)

nano=#    SELECT CTID, XMIN, XMAX, COL1 FROM test1;
 ctid  | xmin | xmax | col1
-------+------+------+------
 (0,1) |  556 |    0 |    1
 (0,4) |  560 |    0 |    5
(2 rows)
```
###### vacuum full 이후
```
nano=# SELECT lp, t_xmin, t_xmax, t_ctid, t_infomask::bit(16)
           ,b'0000001100000000' & t_infomask::bit(16) = b'0000001100000000' as XMIN_FROZEN
           ,t_data
   FROM heap_page_items(get_raw_page('test1', 0));
 lp | t_xmin | t_xmax | t_ctid |    t_infomask    | xmin_frozen |   t_data
----+--------+--------+--------+------------------+-------------+------------
  1 |    556 |      0 | (0,1)  | 0000101100000000 | t           | \x01000000
  2 |    560 |      0 | (0,2)  | 0010101100000000 | t           | \x05000000
(2 rows)

nano=#    SELECT CTID, XMIN, XMAX, COL1 FROM test1;
 ctid  | xmin | xmax | col1
-------+------+------+------
 (0,1) |  556 |    0 |    1
 (0,2) |  560 |    0 |    5
(2 rows)
```
- Dead Tuple이 제거됨과 동시 빈 공간이 사라짐.
- 튜플의 위치도 1,2번으로 순차적으로 정리됨
- 1,2번 튜플의 xmin_frozen이 True로 바뀜.

> ###### 기본 vacuum명령도 freeze기능이 있다.
> 이전 페이지에서 vacuum명령어 수행 후 xmin_frozen 플래그에는 변화가 없었고, vacuum freeze, vacuum full 수행 후에는 해당 플래그가 변경되었다. 그렇다고 vacuum명령에 XID Freeze기능이 없다고 생각하면 안된다. 이유는 후에 서술하겠다.
