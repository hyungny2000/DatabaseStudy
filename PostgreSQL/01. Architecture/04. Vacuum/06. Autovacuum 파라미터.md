## Autovacuum 파라미터

#### vacuum_freeze_table_age
autovacuum시 테이블이 해당 나이 이상이 되면, 해당 테이블에 있는 모든 튜플을 Freeze하게 된다. vacuum_freeze_min_age가 튜플의 Age가 설정값을 넘기면 Freeze하는 튜플 단위 vacuum이라면, 이 파라미터는 해당 테이블의 모든 튜플을 Freeze하는, 보다 공격적인 Freezing을 하게 된다.

#### vacuum_freeze_table_age 테스트

1. vacuum_freeze_table_age 값을 200으로 설정 후 리로드
   ```
   vi postgresql.conf

   vacuum_freeze_table_age = 200

   :wq

   pg_ctl reload
   ```

2. test1 테이블 생성, 데이터 입력 이후 페이지 상태 조회
   ```
   create table test1 (col1 int primary key);

   insert into test1 values(1);

   SELECT lp, t_xmin, t_xmax, t_ctid, t_infomask::bit(16)
           ,b'0000001100000000' & t_infomask::bit(16) = b'0000001100000000' as XMIN_FROZEN
           ,t_data
   FROM heap_page_items(get_raw_page('test1', 0));
   
    lp | t_xmin | t_xmax | t_ctid |    t_infomask    | xmin_frozen |   t_data
   ----+--------+--------+--------+------------------+-------------+------------
     1 |    725 |      0 | (0,1)  | 0000100000000000 | f           | \x01000000

   select relname, age(relfrozenxid) from pg_class where relname='test1';
    relname | age
   ---------+-----
    test1   |   2

   SELECT CTID, XMIN, XMAX, AGE(XMIN), COL1 FROM test1;
    ctid  | xmin | xmax | age | col1
   -------+------+------+-----+------
    (0,1) |  725 |    0 |   1 |    1

   nano=# select txid_current();
    txid_current
   --------------
             726
   (1 row)
   ```
   - test1의 나이는 2, 튜플의 나이는 1이다.
  
3. pgbench 벤치마킹 수행으로 트랜잭션을 약 200 정도 소모시킨다.
   ```
   pgbench -h localhost -p 5432 -U postgres -d pgbench -c 1 -j 4 -t 200
   ```
  
4. XID 확인하여 트랜잭션 소모가 잘 되었는지, 테이블과 튜플의 나이를 조회한다.
   ```
   nano=# select txid_current();
    txid_current
   --------------
             928
   (1 row)

   nano=# select relname, age(relfrozenxid) from pg_class where relname='test1';
    relname | age
   ---------+-----
    test1   | 205
   (1 row)

   nano=# SELECT CTID, XMIN, XMAX, AGE(XMIN), COL1 FROM test1;
    ctid  | xmin | xmax | age | col1
   -------+------+------+-----+------
    (0,1) |  725 |    0 | 204 |    1
   (1 row)
   ```
   - XID : 725 -> 928
   - 테이블 : 2 -> 205
   - 튜플 : 1 -> 204
  
5. vacuum 직후 나이 확인
   ```
   vacuum test1;

   nano=# vacuum test1;
   VACUUM
   nano=# select relname, age(relfrozenxid) from pg_class where relname='test1';
    relname | age
   ---------+-----
    test1   | 208
   (1 row)
   
    lp | t_xmin | t_xmax | t_ctid |    t_infomask    | xmin_frozen |   t_data
   ----+--------+--------+--------+------------------+-------------+------------
     1 |    725 |      0 | (0,1)  | 0000100100000000 | f           | \x01000000

   nano=# SELECT CTID, XMIN, XMAX, AGE(XMIN), COL1 FROM test1;
    ctid  | xmin | xmax | age | col1
   -------+------+------+-----+------
    (0,1) |  725 |    0 | 207 |    1
   (1 row)
   ```
   - ???
