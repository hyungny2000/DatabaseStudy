### 논리백업 - pg_dumpall (글로벌 객체 또한 백업하기 때문에 슈퍼유저 권한필요)

1. 백업디렉토리 생성
postgres@lkmpg:~$ mkdir pg_backup
postgres@lkmpg:~$ cd pg_backup/
postgres@lkmpg:~/pg_backup$ ll
total 8
drwxrwxr-x 2 postgres postgres 4096 Feb 22 13:36 ./
drwxr-xr-x 5 postgres postgres 4096 Feb 22 13:36 ../

2. 백업 
2.1 pg_dumpall
	백업옵션 
	pg_dumpall [connection-option...] [option...]
	-r : role만 백업
	-s : 스키마만 백업, 구조의 정의만 백업한다.
	-t : 테이블스페이스만 백업

postgres@lkmpg:~/pg_backup$ pg_dumpall > dumpall_250222.sql
postgres@lkmpg:~/pg_backup$ pg_dumpall -s > dump_schema_250222.sql
postgres@lkmpg:~/pg_backup$ pg_dumpall -t > dump_ts_250222.sql
postgres@lkmpg:~/pg_backup$ ls -lrt
total 2748
-rw-rw-r-- 1 postgres postgres 2765362 Feb 22 13:37 dumpall_250222.sql
-rw-rw-r-- 1 postgres postgres   39795 Feb 22 13:38 dump_schema_250222.sql
-rw-rw-r-- 1 postgres postgres     208 Feb 22 13:39 dump_ts_250222.sql

덥프 중 에러 발생 시 확인
pg_dumpall -U postgres > backup.sql 2> backup_error.log

2.2 pg_dump
	특정 DB 백업 가능
	글로벅 객체 백업 불가
	사용자 및 권한 백업 불가

	pg_dump [옵션] -U [사용자] -d [데이터베이스] -f [백업파일]
	--serializable-deferrable 백업중 트랜잭션 일관성 유지
	-F c : 압축된(custom format) 백업
	-F d : 디렉토리 형식
	-F t : tar 파일 형식
	-F p : SQL 스크립트 파일 형식 
	-C : create database, connect 포함
	* 함수 백업이 필요할 경우 스키마 백업을 해야한다

	
- 특정 table 백업
postgres@lkmpg:~/pg_backup$ pg_dump -U postgres -d postgres -t customer -f customer.sql

- 특정 SCHEMA 백업
pg_dump -U postgres -d postgres -n public -f SCHEMA.sql

* 비교 
pg_comparator -h localhost -U postgres -d original_db test_restore

2.3 WAL-G
	-WAL-G는 증분 백업을 지원해 저장 공간을 절약하고 빠른 백업을 제공
	-병렬 복구 (Parallel Restore)
	-PITR
	
2.3.1 wal-g download 및 wal-g conf 설정
아래 url에 맞는 OS 버전 및 DB 버전에 다운로드 
https://github.com/wal-g/wal-g/releases


root@lkmpg:/usr/local/bin# wget https://github.com/wal-g/wal-g/releases/latest/download/wal-g-pg-ubuntu-24.04-amd64.tar.gz
--2025-03-08 23:14:52--  https://github.com/wal-g/wal-g/releases/latest/download/wal-g-pg-ubuntu-24.04-amd64.tar.gz
Resolving github.com (github.com)... 20.200.245.247
Connecting to github.com (github.com)|20.200.245.247|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://github.com/wal-g/wal-g/releases/download/v3.0.5/wal-g-pg-ubuntu-24.04-amd64.tar.gz [following]
--2025-03-08 23:14:52--  https://github.com/wal-g/wal-g/releases/download/v3.0.5/wal-g-pg-ubuntu-24.04-amd64.tar.gz
Reusing existing connection to github.com:443.
HTTP request sent, awaiting response... 302 Found
Location: https://objects.githubusercontent.com/github-production-release-asset-2e65be/95143992/9d59beee-6dc6-45cd-8784-0d18396d81ac?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=releaseassetproduction%2F20250308%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20250308T141452Z&X-Amz-Expires=300&X-Amz-Signature=a127da08d916a929fe0da5754bafe8edb462635d19b930036ce14d8f0d220b39&X-Amz-SignedHeaders=host&response-content-disposition=attachment%3B%20filename%3Dwal-g-pg-ubuntu-24.04-amd64.tar.gz&response-content-type=application%2Foctet-stream [following]
--2025-03-08 23:14:52--  https://objects.githubusercontent.com/github-production-release-asset-2e65be/95143992/9d59beee-6dc6-45cd-8784-0d18396d81ac?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=releaseassetproduction%2F20250308%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20250308T141452Z&X-Amz-Expires=300&X-Amz-Signature=a127da08d916a929fe0da5754bafe8edb462635d19b930036ce14d8f0d220b39&X-Amz-SignedHeaders=host&response-content-disposition=attachment%3B%20filename%3Dwal-g-pg-ubuntu-24.04-amd64.tar.gz&response-content-type=application%2Foctet-stream
Resolving objects.githubusercontent.com (objects.githubusercontent.com)... 185.199.110.133, 185.199.108.133, 185.199.109.133, ...
Connecting to objects.githubusercontent.com (objects.githubusercontent.com)|185.199.110.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 16459140 (16M) [application/octet-stream]
Saving to: ‘wal-g-pg-ubuntu-24.04-amd64.tar.gz’

wal-g-pg-ubuntu-24.04-amd64 100%[===========================================>]  15.70M  28.0MB/s    in 0.6s

2025-03-08 23:14:53 (28.0 MB/s) - ‘wal-g-pg-ubuntu-24.04-amd64.tar.gz’ saved [16459140/16459140]

root@lkmpg:/usr/local/bin# ll
total 16084
drwxr-xr-x  2 root root     4096 Mar  8 23:14 ./
drwxr-xr-x 10 root root     4096 Aug 27  2024 ../
-rw-r--r--  1 root root 16459140 Jan 10 22:16 wal-g-pg-ubuntu-24.04-amd64.tar.gz
root@lkmpg:/usr/local/bin# tar -zxvf wal-g-pg-ubuntu-24.04-amd64.tar.gz
wal-g-pg-ubuntu-24.04-amd64
root@lkmpg:/usr/local/bin# ll
total 78956
drwxr-xr-x  2 root root     4096 Mar  8 23:15 ./
drwxr-xr-x 10 root root     4096 Aug 27  2024 ../
-rwxr-xr-x  1 root root 64378432 Jan 10 22:16 wal-g-pg-ubuntu-24.04-amd64*
-rw-r--r--  1 root root 16459140 Jan 10 22:16 wal-g-pg-ubuntu-24.04-amd64.tar.gz
root@lkmpg:/usr/local/bin# mv wal-g-pg-ubuntu-24.04-amd64 wal-g
root@lkmpg:/usr/local/bin# ll
total 78956
drwxr-xr-x  2 root root     4096 Mar  8 23:15 ./
drwxr-xr-x 10 root root     4096 Aug 27  2024 ../
-rwxr-xr-x  1 root root 64378432 Jan 10 22:16 wal-g*
-rw-r--r--  1 root root 16459140 Jan 10 22:16 wal-g-pg-ubuntu-24.04-amd64.tar.gz
root@lkmpg:/usr/local/bin# wal-g --version
wal-g version v3.0.5    94bf839 2025.01.10_13:15:40     PostgreSQL
root@lkmpg:/usr/local/bin# su - postgres
postgres@lkmpg:~$ wal-g --version
wal-g version v3.0.5    94bf839 2025.01.10_13:15:40     PostgreSQL

아카이브 다운로드 할 경로에 conf 파일인 .walg.json 설정하였음 (경로 변경 및 default conf파일 있음)

postgres@lkmpg:~/pg_archive_test$ cat .walg.json
{
  "WALG_FILE_PREFIX": "/var/lib/postgresql/pg_archive_test",
  "PGHOST": "localhost",
  "PGPORT": "5432",
  "PGDATA": "/var/lib/postgresql/15/main"
}

2.3.2 postgresql conf 설정 및 재기동
archive_mode = on               # enables archiving; off, on, or always
                                # (change requires restart)
#archive_library = ''           # library to use to archive a logfile segment
                                # (empty string indicates archive_command should
                                # be used)
archive_command = 'wal-g wal-push %p'            # command to use to archive a logfile segment
                                # placeholders: %p = path of file to archive
                                #               %f = file name only
                                # e.g. 'test ! -f /mnt/server/archivedir/%f && cp %p /mnt/server/archivedir/%f'
archive_timeout = 60            # force a logfile segment switch after this
                                # number of seconds; 0 disables


config 적용확인
postgres@lkmpg:/etc/postgresql/15/main$ psql
psql (15.12 (Ubuntu 15.12-1.pgdg24.04+1))
Type "help" for help.

postgres=# show archive_mode;
 archive_mode
--------------
 on
(1 row)

postgres=# show archive_command;
  archive_command
-------------------
 wal-g wal-push %p
(1 row)

2.3.3 full backup 생성 (wal-g backup-push)

postgres@lkmpg:~/pg_archive_test$ WALG_FILE_PREFIX=/var/lib/postgresql/pg_archive_test/ wal-g backup-push /var/lib/postgresql/15/main
INFO: 2025/03/08 23:27:44.876329 Backup will be pushed to storage: default
INFO: 2025/03/08 23:27:44.902214 Calling pg_start_backup()
INFO: 2025/03/08 23:27:44.941664 Initializing the PG alive checker (interval=1m0s)...
INFO: 2025/03/08 23:27:44.941689 Starting a new tar bundle
INFO: 2025/03/08 23:27:44.941702 Walking ...
INFO: 2025/03/08 23:27:44.941821 Starting part 1 ...
INFO: 2025/03/08 23:27:46.845016 Packing ...
INFO: 2025/03/08 23:27:46.849183 Finished writing part 1.
INFO: 2025/03/08 23:27:46.849236 Starting part 2 ...
INFO: 2025/03/08 23:27:46.849256 /global/pg_control
INFO: 2025/03/08 23:27:46.849414 Finished writing part 2.
INFO: 2025/03/08 23:27:46.849426 Calling pg_stop_backup()
INFO: 2025/03/08 23:27:46.860318 Starting part 3 ...
INFO: 2025/03/08 23:27:46.860662 backup_label
INFO: 2025/03/08 23:27:46.860685 tablespace_map
INFO: 2025/03/08 23:27:46.860758 Finished writing part 3.
INFO: 2025/03/08 23:27:46.861027 Querying pg_database
INFO: 2025/03/08 23:27:46.918593 Wrote backup with name base_000000010000000000000006 to storage default

drwxr-xr-x 3 postgres postgres 4096 Mar  8 23:27 ./
drwxrwxr-x 3 postgres postgres 4096 Mar  8 23:24 ../
drwxr-xr-x 3 postgres postgres 4096 Mar  8 23:27 base_000000010000000000000006/
-rw-rw-r-- 1 postgres postgres  414 Mar  8 23:27 base_000000010000000000000006_backup_stop_sentinel.json

backup-list 로 해당 백업본이 생긴것을 확인 (wal-g backup-list)

postgres@lkmpg:~/pg_archive_test$ wal-g --config config.json backup-list
INFO: 2025/03/08 23:36:09.025172 List backups from storages: [default]
backup_name                   modified                  wal_file_name            storage_name
base_000000010000000000000006 2025-03-08T23:27:46+09:00 000000010000000000000006 default

backup 파일 검증 (wal-g wal-verify)

✅ --integrity → WAL 파일 손상 여부 확인
✅ --timeline → WAL 파일의 타임라인 연속성 확인

postgres@lkmpg:~/pg_archive_test$ wal-g wal-verify integrity timeline --config config.json
INFO: 2025/03/08 23:42:18.314028 Current WAL segment: 000000010000000000000008
INFO: 2025/03/08 23:42:18.315036 Building check runner: integrity
INFO: 2025/03/08 23:42:18.315353 Detected earliest available backup: base_000000010000000000000006
INFO: 2025/03/08 23:42:18.315363 Running the check: integrity
[wal-verify] integrity check status: WARNING
[wal-verify] integrity check details:
+-----+--------------------------+--------------------------+----------------+-------------------+
| TLI | START                    | END                      | SEGMENTS COUNT |            STATUS |
+-----+--------------------------+--------------------------+----------------+-------------------+
|   1 | 000000010000000000000006 | 000000010000000000000007 |              2 | MISSING_UPLOADING |
+-----+--------------------------+--------------------------+----------------+-------------------+
