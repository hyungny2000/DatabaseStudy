# Unlogged Table

## 정의
- 테이블 데이터 변경시 복구를 위한 XLog Record를 남기지 않는 테이블.
- XLog Record 생성이 생략되므로 일반 테이블보다 입출력 속도가 매우 빠르다.
- XLog Record를 남기지 않으므로 복구 불가.

## Unlogged 테이블 생성
```
CREATE UNLOGGED TABLE TEST1_UNLOG (COL1 INT PRIMARY KEY, COL_TEST VARCHAR(10));
```

## Unlogged 테이블 로깅 & 성능 테스트
### 테스트 환경 구축
1. 대조군 테이블 생성
    ```
    CREATE TABLE TEST1 (COL1 INT PRIMARY KEY, COL_TEST VARCHAR(10));
    ```

2. Unlogged / 대조군 테이블에 데이터 각각 생성
    ```
    insert into test1_unlog select generate_series(1,1000), 'test';
    insert into TEST1 select generate_series(1,1000), 'test';

    select count(*) from test1_unlog; -- 1000
    select count(*) from test1; -- 1000
    ``` 
3. pgbench update 스크립트 생성
   1. test1_unlog 테이블 update 스크립트트
        ```
        vi test1_update_test_unlog.sql

        \set col1_cond random(1, 1000)
        UPDATE test1_unlog SET COL_TEST = to_char(now(), 'HH24MISS') WHERE COL1 = :col1_cond;

        :wq
        ```
   2. test1 테이블 update 스크립트
        ```
        vi test1_update_test.sql

        \set col1_cond random(1, 1000)
        UPDATE TEST1 SET COL_TEST = to_char(now(), 'HH24MISS') WHERE COL1 = :col1_cond;

        :wq
        ```
### 테스트
1. pgbench 벤치마킹
   1. Unlogged 테이블 테스트
    ```
    [세션#1]
    select pg_current_wal_lsn(); -- 기록

    [세션#2]
    pgbench -U postgres -d nano -f test1_update_test_unlog.sql -t 600 -c 10 -j 1
    
    [세션#1]
    select pg_wal_lsn_diff(pg_current_wal_lsn(), '0/2AD7068'); -- 벤치마킹 전 LSN을 2번째 인자에 기록
    ```
    - 세션 1개 당 600 트랜잭션, 10개 세션으로 테스트
  
   2. 대조군 테이블 테스트
    ```
    [세션#1]
    pg_current_wal_lsn(); -- 기록

    [세션#2]
    pgbench -U postgres -d nano -f test1_update_test.sql -t 600 -c 10 -j 1
    
    [세션#1]
    select pg_wal_lsn_diff(pg_current_wal_lsn(), '0/2AD7068'); -- 벤치마킹 전 LSN을 2번째 인자에 기록
    ```
    - 세션 1개 당 600 트랜잭션, 10개 세션으로 테스트

5. 테스트 결과
   1. Unlogged 테이블
    ```
    postgres=# select pg_current_wal_lsn();
     pg_current_wal_lsn
    --------------------
     0/2AD7068
    (1 row)

    postgres=# select pg_wal_lsn_diff(pg_current_wal_lsn(),'0/2AD7068');
     pg_wal_lsn_diff
    -----------------
              240752
    (1 row)

    transaction type: test1_update_test_unlog.sql
    scaling factor: 1
    query mode: simple
    number of clients: 10
    number of threads: 1
    number of transactions per client: 600
    number of transactions actually processed: 6000/6000
    latency average = 0.428 ms
    tps = 23349.780711 (including connections establishing)
    tps = 23557.496698 (excluding connections establishing)
    [postgres@postdb01 dba]$
    ```

2. 대조군 테이블
    ```
    postgres=# select pg_current_wal_lsn();
     pg_current_wal_lsn
    --------------------
     0/2B11CD8
    (1 row)

    postgres=# select pg_wal_lsn_diff(pg_current_wal_lsn(),'0/2AD7068');
     pg_wal_lsn_diff
    -----------------
             1187152

    transaction type: test1_update_test.sql
    scaling factor: 1
    query mode: simple
    number of clients: 10
    number of threads: 1
    number of transactions per client: 600
    number of transactions actually processed: 6000/6000
    latency average = 1.949 ms
    tps = 5130.361603 (including connections establishing)
    tps = 5148.474416 (excluding connections establishing)
    [postgres@postdb01 dba]$
    ```
### 테스트 결과
| 항목 | Unlogged 테이블 | 대조군 테이블 | 비교 | 
| --- | --- | --- | --- |
| WAL 생성량 | 240752 | 1187152 | 일반 테이블 대비 1/4 수준 |
| 평균 Latency | 0.428 ms | 1.949 ms | 일반 테이블 대비 1/4 수준 |
| TPS (DB연결 포함) | 23349 | 5130 | 일반 테이블 대비 4.5배 |
| TPS (DB연결 제외) | 23557 | 5148 | 일반 테이블 대비 4.5배 |
- Unlogged 테이블이 일반테이블 대비 WAL 생성은 1/4, 성능은 4배 이상으로 월등히 앞서나감.
