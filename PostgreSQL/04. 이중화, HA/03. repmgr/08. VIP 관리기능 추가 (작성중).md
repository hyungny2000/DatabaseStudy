## VIP 관리기능 추가
#### VIP(Virtual IP)란
- 특정 NIC에 고정 할당된 IP주소가 아닌 가상의 IP주소라는 뜻에서 가상(Virtual) IP라고 칭함

#### Virtual IP가 왜 필요한가
###### VIP가 없을 경우
1. 평상시에는 마스터DB 서버의 IP로 세팅하여 서비스 진행
2. FailOver되어 마스터 역할이 스탠바이DB로 절체되면 App단에서는 스탠바이DB서버의 IP로 변경해야 함.
3. App단에서 DB IP를 전부 변경하여 재기동하는 동안 시간이 오래 걸려 고가용성이 현저히 저하됨.
###### VIP가 있을 경우
1. App단에서는 DB접속시 VIP를 DB의 IP로 세팅하여 서비스를 진행
1. 평상시에는 VIP가 마스터DB에 있으므로 마스터DB서버에 접속함
2. Failover되어 스탠바이DB가 마스터가 되면, VIP는 수 초 내에 마스터에서 제거, 스탠바이 서버에 추가되어 실행됨.
3. App단에서는 수 초 내에 자연히 VIP가 있는 스탠바이DB에 접속하게 되어 고가용성 준수.

#### VIP관리에 필요한 개념
##### sudo
`sudo`란 서버에서 일반 계정이 root계정으로 해야 할 작업을 수행할 때 필요한 명령어이다. Windows의 **관리자 권한으로 실행**이 바로 이 개념이다.
VIP를 추가,제거하는 작업은 원래 root계정, 서버Admin이 해야 하는 일이므로, 일반계정인 postgres가 작업하려면 시스템으로부터 실행권한을 부여받아야 하며, 실행 시 항상 `sudo`를 앞에 붙여주어야 한다. 예를 들면 이런 식이다. 
```
[postgres@postdb01] sudo ip addr add XXX.XXX.XXX.XXX dev eth0
```
시스템 차원에서 postgres에 sudo 권한을 부여하려면 `visudo` 명령으로 sudoer 파일을 편집하면 된다.

##### Interface
쉽게 말해 가정용 컴퓨터의 LAN카드를 기업용 서버에서는 NIC(Network Interface Card) 또는 Interface라고 한다. 
VIP 절체는 바로 Interface에 VIP를 추가,제거하는 작업이다.
##### ARP (Address Resolution Protocol)
주소 결정 프로토콜(Address Resolution Protocol)의 약자로, 네트워크 상에서 IP를 물리적 주소(MAC)와 매핑시키기 위한 프로토콜.
VIP를 A서버의 인터페이스에 추가했다 해도 ARP에서 VIP와 A컴퓨터를 매핑시키지 않으면 외부에선 VIP로 A컴퓨터에 접속할 수 없다. 
ARP 매핑은 `arping`으로 간단히 실행할 수 있다.
##### Passwordless SSH
`ssh`명령으로 로컬 서버에서 동일한 네트워크 대역 내의 다른 원격서버의 명령을 수행할 수 있다. A서버와 B서버가 동일한 대역에 있다면 A서버에서 B서버를 재부팅시킬 수도 있다는 뜻이다.
이를 이용해 VIP를 관리할 때 `ssh` 명령을 사용한다. 이것을 셀스크립트가 자동으로 수행할 수 있어야 하는데, 문제는 `ssh`를 수행할 때 패스워드를 물어본다는 것.
셀스크립트가 패스워드를 입력하는 상황을 피하기 위해 **패스워드 없이** `ssh`명령을 실행하게 해야 한다.
##### VIP Fencing
DB이중화 과정에서 마스터와 스탠바이 서버 양쪽에 VIP가 동시에 떠 있으면 IP충돌이 발생한다. 이를 방지하는 개념을 VIP Fencing이라 한다.
VIP Fencing을 고려해야 하는 시나리오는 다음과 같다. (이는 좀 생각해 보자)
- A
- 마스터DB서버가 Hang 상태여서 어떤 명령도 듣지 않는 상태. VIP도 마찬가지로 마스터서버에 계속 떠 있는 상황
- C    

VIP 충돌을 예방하기 위해서는 다음 순서로 VIP가 절체되어야 한다.
1. 무슨 수를 써서라도 장애발생한 마스터 서버의 VIP를 **먼저** 제거한다. `ip addr del`을 사용할 수도 있고, 극단적으로는 서버를 재부팅해서라도.
3. 신규 마스터DB 서버에 VIP를 추가한다. `apring`도 잊지 말자.


#### 대략적인 VIP관리방법
위 개념들을 통해 이중화 환경에서 VIP관리는 다음과 같이 할 수 있겠다.
1. 이중화 노드 모두 기동하는 시점에서 마스터DB를 판별. VIP를 마스터서버에 부여한다.
2. 마스터DB장애 발생 시 Fail-Over 상황에서, 마스터 서버의 VIP를 먼저 제거한다.
3. 특정 스탠바이DB가 마스터로 승급되면, 신규 마스터 서버에 VIP를 추가한다. `arping`도 함께 해야 한다.
