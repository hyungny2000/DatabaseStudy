## Failover 및 Rejoin 테스트

#### 테스트 시나리오
1. 마스터DB(postrm01)를 정지시켜 장애상황을 가정한다.
1. repmgrd에서 마스터DB 장애를 감지하여 스탠바이DB(postrm02)를 마스터DB로 승격한다. 현 마스터DB(postrm02)에서 서비스하면서 데이터 변경이 발생한다.
1. 구 마스터DB(postrm01)을 정상기동하여 repmgr 클러스터로 rejoin을 수행한다.
2. Rejoin이 완료되어 구 마스터DB는 현 마스터DB의 스탠바이로 동작하며, 마스터의 변경사항은 그대로 적용된다.

#### Failover 테스트
마스터DB shutdown
```
pg_ctl stop
```

#### 클러스터 상태 확인
```
repmgr -f /var/lib/pgsql/12/repmgr/repmgr.conf cluster show
```

#### 현 마스터DB 데이터 변경
현재 마스터DB에 데이터를 추가하여 서비스에 의해 지속적으로 데이터가 변경되는 상황 연출
```
create database nano
\c nano
create table test1 (col1 int primary key);
insert into test1 values(1);
insert into test1 values(2);
insert into test1 values(3);
```

#### 구 마스터DB 기동
```
pg_ctl start
```

#### 현 마스터DB 체크포인트
```
repmgr -f /var/lib/pgsql/12/repmgr/repmgr.conf repmgr.conf node service --action=restart --checkpoint
```

#### 구 마스터DB Rejoin
```
repmgr -f /var/lib/pgsql/12/repmgr/repmgr.conf node rejoin -d 'host=172.20.0.112 user=repmgr dbname=repmgr' --force-rewind --config-files=postgresql.local.conf,postgresql.conf --verbose --dry-run 
repmgr -f /var/lib/pgsql/12/repmgr/repmgr.conf node rejoin -d 'host=172.20.0.112 user=repmgr dbname=repmgr' --force-rewind --config-files=postgresql.local.conf,postgresql.conf --verbose
```
- `--force-rewind` : pg_rewind를 이용하여 구 마스터DB의 데이터를 최신데이터로 강제복구하는 옵션.
- `--config-files` : pg_rewind 이후 마스터DB에서 가져와서 덮어씌울 설정파일을 지정하는 옵션.
> #### pg_rewind
> 원격 DB클러스터로부터 데이터 변경사항을 가져와 로컬DB클러스터를 동기화시키는 명령어.
> ([pg_rewind 매뉴얼](https://postgresql.kr/docs/11/app-pgrewind.html))

#### 클러스터 상태 확인
```
repmgr -f /var/lib/pgsql/12/repmgr/repmgr.conf cluster show
```

#### 구 마스터(현 스탠바이DB) 데이터 적용여부 확인
```
psql
\l
\c nano
select * from test1;
```
