## Repmgr 에러조치

### Case#1 스탠바이노드 접속실패로 Failover 실패

#### 상황
primary 노드 down으로 failover해야 하는데, standby node 접속이 안되어 failover에 실패하는상황

##### cluster show 조회결과
```
[postgres@postrm02 ~]$ repmgr -f /var/lib/pgsql/12/repmgr/repmgr.conf cluster show
 ID | Name    | Role    | Status        | Upstream  | Location | Priority | Timeline | Connection string
----+---------+---------+---------------+-----------+----------+----------+----------+---------------------------------------------------------------
 1  | primary | primary | ? unreachable | ?         | default  | 100      |          | host=172.20.0.112 user=repmgr dbname=repmgr connect_timeout=2
 2  | standby | standby |   running     | ? primary | default  | 100      | 1        | host=172.20.0.113 user=repmgr dbname=repmgr connect_timeout=2

WARNING: following issues were detected
  - unable to connect to node "primary" (ID: 1)
  - node "primary" (ID: 1) is registered as an active primary but is unreachable
  - unable to connect to node "standby" (ID: 2)'s upstream node "primary" (ID: 1)
  - unable to determine if node "standby" (ID: 2) is attached to its upstream node "primary" (ID: 1)
```

1. primary node 기동 후 cluster show 조회결과
```
[postgres@postrm02 repmgr]$ repmgr -f /var/lib/pgsql/12/repmgr/repmgr.conf cluster show
 ID | Name    | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string
----+---------+---------+-----------+----------+----------+----------+----------+---------------------------------------------------------------
 1  | primary | primary | * running |          | default  | 100      | 1        | host=172.20.0.112 user=repmgr dbname=repmgr connect_timeout=2
 2  | standby | standby |   running | primary  | default  | 100      | 1        | host=172.20.0.113 user=repmgr dbname=repmgr connect_timeout=2
[postgres@postrm02 repmgr]$
```

2. primary node는 놔두고 standby promote 실행
```
/usr/pgsql-12/bin/repmgr standby promote -f /var/lib/pgsql/12/repmgr/repmgr.conf
```
실행결과
```
[postgres@postrm02 repmgr]$ /usr/pgsql-12/bin/repmgr standby promote -f /var/lib/pgsql/12/repmgr/repmgr.conf
NOTICE: promoting standby to primary
DETAIL: promoting server "standby" (ID: 2) using pg_promote()
NOTICE: waiting up to 60 seconds (parameter "promote_check_timeout") for promotion to complete
NOTICE: STANDBY PROMOTE successful
DETAIL: server "standby" (ID: 2) was successfully promoted to primary

[postgres@postrm02 repmgr]$ repmgr -f /var/lib/pgsql/12/repmgr/repmgr.conf cluster show
 ID | Name    | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string
----+---------+---------+-----------+----------+----------+----------+----------+---------------------------------------------------------------
 1  | primary | primary | - failed  | ?        | default  | 100      |          | host=172.20.0.112 user=repmgr dbname=repmgr connect_timeout=2
 2  | standby | primary | * running |          | default  | 100      | 2        | host=172.20.0.113 user=repmgr dbname=repmgr connect_timeout=2

WARNING: following issues were detected
  - unable to connect to node "primary" (ID: 1)

```

   3. `pg_ctl start`로 primary node 기동 후 rejoin 시도
   ```
[postgres@postrm01 data]$ pg_ctl start
waiting for server to start....2025-02-06 22:50:35.148 UTC [396] LOG:  starting PostgreSQL 12.22 on aarch64-unknown-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-22), 64-bit
2025-02-06 22:50:35.149 UTC [396] LOG:  listening on IPv4 address "0.0.0.0", port 5432
2025-02-06 22:50:35.150 UTC [396] LOG:  listening on IPv6 address "::", port 5432
2025-02-06 22:50:35.160 UTC [396] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
2025-02-06 22:50:35.166 UTC [396] LOG:  listening on Unix socket "/tmp/.s.PGSQL.5432"
2025-02-06 22:50:35.192 UTC [396] LOG:  redirecting log output to logging collector process
2025-02-06 22:50:35.192 UTC [396] HINT:  Future log output will appear in directory "log".
 done
server started
[postgres@postrm01 data]$ repmgr -f /var/lib/pgsql/12/repmgr/repmgr.conf cluster show
 ID | Name    | Role    | Status               | Upstream | Location | Priority | Timeline | Connection string

----+---------+---------+----------------------+----------+----------+----------+----------+---------------------------------------------------------------
 1  | primary | primary | * running            |          | default  | 100      | 1        | host=172.20.0.112 user=repmgr dbname=repmgr connect_timeout=2
 2  | standby | standby | ! running as primary |          | default  | 100      | 2        | host=172.20.0.113 user=repmgr dbname=repmgr connect_timeout=2

WARNING: following issues were detected
  - node "standby" (ID: 2) is registered as standby but running as primary
   ```


#### 설정값 확인
##### repmgr.conf of primary node
```
node_id=1
node_name='primary'
conninfo='host=172.20.0.112 user=repmgr dbname=repmgr connect_timeout=2'
data_directory='/var/lib/pgsql/12/data/'
failover=automatic
promote_command='/usr/pgsql-12/bin/repmgr standby promote -f /var/lib/pgsql/12/repmgr/repmgr.conf'
follow_command='/usr/pgsql-12/bin/repmgr standby follow -f /var/lib/pgsql/12/repmgr/repmgr.conf'
pg_bindir='/usr/pgsql-12/bin'
log_file='/var/lib/pgsql/12/repmgr/repmgr.log'
```

##### repmgr.conf of standby node
```
node_id=2
node_name='standby'
conninfo='host=172.20.0.113 user=repmgr dbname=repmgr connect_timeout=2'
data_directory='/var/lib/pgsql/12/data/'
failover=automatic
promote_command='/usr/pgsql-12/bin/repmgr standby promote -f /var/lib/pgsql/12/repmgr/repmgr.conf'
follow_command='/usr/pgsql-12/bin/repmgr standby follow -f /var/lib/pgsql/12/repmgr/repmgr.conf'
pg_bindir='/usr/pgsql-12/bin'
log_file='/var/lib/pgsql/12/repmgr/repmgr.log'
```



