## Keepalived로 VIP관리

#### Keepalived
- DB와는 별개의 솔루션으로 VIP를 전문으로 관리하는 패키지
- VRRP프로토콜을 사용하여 고가용성(High Availability)이 높다고 한다.
- keepalived만 사용한다면 Passwordless SSH는 불필요함.

#### postrm01,02에 Keepalived 설치
```
yum -y install keepalived
```

#### Keepalived 설정파일 백업 및 확인
```
cd /etc/keepalived
mv /keepalived.conf keepalived.conf.orig
vi keepalived.conf
```

#### keepalived.conf 설정 (참고, [유튜브 영상](https://www.youtube.com/watch?v=EwQSOlspxeU), [블로그](https://dewble.tistory.com/entry/install-keepalived-from-yum-in-centos-7))
```
vrrp_script chk_haproxy {
    script "/var/lib/pgsql/12/repmgr/keepalived_pgsql_chk.sh"
    interval 2
    weight 4
}
vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    unicast_src_ip 172.20.0.112
    unicast_peer {
        172.20.0.113
    }
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        172.20.0.115
    }
    track_script{
        chk_haproxy
    }
}
```
- chk_haproxy : 헬스체크하는 스크립트로 추정됨
- interval : 체크 주기 (현재 2초 설정)
- weight : 스크립트 실패 시 변경할 weight 값 조정
  - 양수 : 우선순위 상향
  - 음수 : 우선순위 하향
- state : 노드의 초기상태
  - MASTER : 초기 마스터 서버
  - BACKUP : FAILOVER시 마스터가 될 서버
- interface : VIP의 인터페이스
- virtual_router_id : 가상라우터 아이디 (모든 클러스터 내에서 동일해야 함)
- priority : 숫자가 클 수록 우선순위가 높아 우선적으로 마스터가 됨
- advert_int : 상태알림 패킷 전송주기 (1은 1초 단위)
- unicast_src_ip : 로컬 노드의 IP
- unicast_peer : 이웃 노드의 IP
- authentication : VRRP 패킷 인증정설정
  - auth_type PASS : 인증방식 설정 (PASS는 패스워드, AH는 IPSec 인증)
  - auth_pass 1111 : 패스워드 설정 (모든 노드에서 동일해야 함)
- virtual_ipaddress : VIP
- track_script : 헬스체크 스크립트를 지정

#### keepalived_pgsql_chk.sh 작성 (postrm01, postrm02)
```
#!/bin/bash
# PostgreSQL Standby 여부 확인
if [ -f "/var/lib/pgsql/12/data/standby.signal" ]; then
    exit 1  # Standby이면 비정상 처리하여 VIP를 이동시킴
fi

PGSTATUS=$(/usr/pgsql-12/bin/pg_isready -U postgres -h 127.0.0.1)
if [[ $PGSTATUS == *"accepting connections"* ]]; then
    exit 0
else
    exit 1
fi
```
- 정상이면 `exit 0`, 비정상이면 `exit 1` 반환
- 동작 원리
  1. standby.signal이 있으면 스탠바이DB이므로 비정상 종료
  2. standby.signal이 없으면 마스터DB로 인식하여 pg_isready로 DB오픈여부 체크
     1. accepting connections이면 `exit 0` 반환
     2. accepting connections이 아니면 `exit 1` 반환
- `chmod 700 keepalived_pgsql_chk.sh`으로 실행권한 부여해야 함.
  > 이 노드에 standby.signal이 없고, pg_isready=true이어도 repmgr클러스터에 참여하지 않으면 VIP를 넘겨받아서는 안됨

### keepalived 실행
```
systemctl enable keepalived
systemctl start keepalived
```
- `systemctl enable keepalived` : 시스템 부팅 시 keepalived 서비스 자동 시작
- `systemctl start keepalived` : keepalived 서비스 시작


#### ip addr 결과 조회
```
[postgres@postrm01 repmgr]$ ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
12: eth0@if13: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:ac:14:00:70 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.20.0.112/16 brd 172.20.255.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet 172.20.0.115/32 scope global eth0
       valid_lft forever preferred_lft forever

[postgres@postrm02 ~]$ ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
8: eth0@if9: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:ac:14:00:71 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.20.0.113/16 brd 172.20.255.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet 192.168.200.16/32 scope global eth0
       valid_lft forever preferred_lft forever
    inet 192.168.200.17/32 scope global eth0
       valid_lft forever preferred_lft forever
    inet 192.168.200.18/32 scope global eth0
       valid_lft forever preferred_lft forever
```
- postrm01은 `inet 172.20.0.115/32 scope global eth0`이 확인됨
- postrm02는 VIP대역은 안보임. 근데 192.168.200.16~18 이 주소들은 뭐지?
  - 172.20 대역이라 저 IP가 충돌을 일으키지는 않을 듯 하지만.....

#### repmgrd 기동 후 Failover 테스트

```
[postgres@postrm-witness ~]$ repmgr -f /var/lib/pgsql/12/repmgr/repmgr.conf cluster show
 ID | Name           | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                                          
----+----------------+---------+-----------+----------+----------+----------+----------+---------------------------------------------------------------
 1  | postrm01       | primary | * running |          | default  | 100      | 1        | host=172.20.0.112 user=repmgr dbname=repmgr connect_timeout=2
 2  | postrm02       | standby |   running | postrm01 | default  | 100      | 1        | host=172.20.0.113 user=repmgr dbname=repmgr connect_timeout=2
 3  | postrm-witness | witness | * running | postrm01 | default  | 0        | n/a      | host=172.20.0.114 user=repmgr dbname=repmgr connect_timeout=2
```

#### 마스터DB(postrm01) DB 정지
```
pg_ctl stop
```

#### 정지 후 Failover 완료
```
[postgres@postrm-witness ~]$ repmgr -f /var/lib/pgsql/12/repmgr/repmgr.conf cluster show
 ID | Name           | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string

----+----------------+---------+-----------+----------+----------+----------+----------+---------------------------------------------------------------
 1  | postrm01       | primary | - failed  | ?        | default  | 100      |          | host=172.20.0.112 user=repmgr dbname=repmgr connect_timeout=2
 2  | postrm02       | primary | * running |          | default  | 100      | 2        | host=172.20.0.113 user=repmgr dbname=repmgr connect_timeout=2
 3  | postrm-witness | witness | * running | postrm02 | default  | 0        | n/a      | host=172.20.0.114 user=repmgr dbname=repmgr connect_timeout=2

WARNING: following issues were detected
  - unable to connect to node "postrm01" (ID: 1)
```

### VIP절체여부 확인
```
[postgres@postrm01 repmgr]$ ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
12: eth0@if13: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:ac:14:00:70 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.20.0.112/16 brd 172.20.255.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet 172.20.0.115/32 scope global eth0
       valid_lft forever preferred_lft forever

[postgres@postrm02 ~]$ ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
8: eth0@if9: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:ac:14:00:71 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.20.0.113/16 brd 172.20.255.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet 192.168.200.16/32 scope global eth0
       valid_lft forever preferred_lft forever
    inet 192.168.200.17/32 scope global eth0
       valid_lft forever preferred_lft forever
    inet 192.168.200.18/32 scope global eth0
       valid_lft forever preferred_lft forever
```
- 절체가 안되고 있음.....