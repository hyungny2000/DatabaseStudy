## Keepalived로 VIP관리

#### Keepalived
- DB와는 별개의 솔루션으로 VIP를 전문으로 관리하는 패키지
- VRRP프로토콜을 사용하여 고가용성(High Availability)이 높다고 한다.
- keepalived만 사용한다면 Passwordless SSH는 불필요함.

#### postrm01,02에 Keepalived 설치
```
yum -y install keepalived
```

#### Keepalived 설정파일 백업 및 확인
```
cd /etc/keepalived
mv /keepalived.conf keepalived.conf.orig
vi keepalived.conf
```

#### keepalived.conf 설정 (참고, [유튜브 영상](https://www.youtube.com/watch?v=EwQSOlspxeU), [블로그](https://dewble.tistory.com/entry/install-keepalived-from-yum-in-centos-7))
```
vrrp_script chk_haproxy {
    script "/var/lib/pgsql/12/repmgr/keepalived_pgsql_chk.sh"
    interval 2
    weight 4
}
vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    unicast_src_ip 172.20.0.112
    unicast_peer {
        172.20.0.113
    }
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        172.20.0.115
    }
    track_script{
        chk_haproxy
    }
}
```
- chk_haproxy : 헬스체크하는 스크립트로 추정됨
- interval : 체크 주기 (현재 2초 설정)
- weight : 스크립트 실패 시 변경할 weight 값 조정
  - 양수 : 우선순위 상향
  - 음수 : 우선순위 하향
- state : 노드의 초기상태
  - MASTER : 초기 마스터 서버
  - BACKUP : FAILOVER시 마스터가 될 서버
- interface : VIP의 인터페이스
- virtual_router_id : 가상라우터 아이디 (모든 클러스터 내에서 동일해야 함)
- priority : 숫자가 클 수록 우선순위가 높아 우선적으로 마스터가 됨
- advert_int : 상태알림 패킷 전송주기 (1은 1초 단위)
- unicast_src_ip : 로컬 노드의 IP
- unicast_peer : 이웃 노드의 IP
- authentication : VRRP 패킷 인증정설정
  - auth_type PASS : 인증방식 설정 (PASS는 패스워드, AH는 IPSec 인증)
  - auth_pass 1111 : 패스워드 설정 (모든 노드에서 동일해야 함)
- virtual_ipaddress : VIP
- track_script : 헬스체크 스크립트를 지정

#### keepalived_pgsql_chk.sh
```
#!/bin/bash
# PostgreSQL Standby 여부 확인
if [ -f "/var/lib/pgsql/12/data/standby.signal" ]; then
    exit 1  # Standby이면 비정상 처리하여 VIP를 이동시킴
fi

PGSTATUS=$(pg_isready -U postgres -h 127.0.0.1)
if [[ $PGSTATUS == *"accepting connections"* ]]; then
    exit 0
else
    exit 1
fi
```
- 정상이면 `exit 0`, 비정상이면 `exit 1` 반환
- 동작 원리
  1. standby.signal이 있으면 스탠바이DB이므로 비정상 종료
  2. standby.signal이 없으면 마스터DB로 인식하여 pg_isready로 DB오픈여부 체크
     1. accepting connections이면 `exit 0` 반환
     2. accepting connections이 아니면 `exit 1` 반환
- chmod 700 keepalived_pgsql_chk.sh으로 실행권한 부여해야 함.

### keepalived 실행
```
systemctl enable keepalived
systemctl start keepalived
```
- `systemctl enable keepalived` : 시스템 부팅 시 keepalived 서비스 자동 시작
- `systemctl start keepalived` : keepalived 서비스 시작


