## repmgr계정에서 Superuser 권한 빼기 (v14 ~)

#### 참고자료
[참고 : repmgr db계정 권한 링크](https://www.repmgr.org/docs/current/configuration-permissions.html)

#### repmgr 일반계정에 필요한 권한

###### 1. Replication Role
- replication 롤을 보유한 일반계정
  ```
  create user repmgr with replication encrypted password 'repmgr';
  ```

###### 2. 다음 롤 권한 (14v ~)
- pg_read_all_stats : pg_stats로 시작하는 모든 뷰 조회권한
- pg_read_all_settings : 모든 설정값 조회권한
- pg_monitor : pg_read_all_stats, pg_read_all_settings 롤을 포함한 롤, 이 롤 권한 부여하여 대체 가능
- pg_checkpoint : CHECKPOINT 명령 실행가능한 롤 권한. (14v 이상)
- 권한 부여 구문
  ```sql
  grant pg_monitor, pg_checkpoint to repmgr;
  ```

###### 3. repmgr 확장 생성
- repmgr 계정이 superuser이면 `create extension repmgr` 명령을 자동으로 실행
- `repmgr primary register` 이전에 superuser계정(예 : postgres)으로 `create extension repmgr`을 직접 실행해야 함.

###### 4. 함수 실행권한
- pg_wal_replay_resume() : Failover 시 스탠바이 서버의 WAL Replay 재개를 위해 필요함.
- pg_promote() : 스탠바이 서버의 Promotion을 위해 필요함. 권한 부재시 `pg_ctl promote`로 실행함.
- 실행권한 부여 구문
  ```sql
  grant execute on function pg_wal_replay_resume to repmgr;
  grant execute on function pg_promote to repmgr;
  ```

###### 5. 기타
- repmgr.conf에서 `standby_disconnect_on_failover = true`된 경우, repmgr 계정에서 `ALTER SYSTEM`문을 사용. 14버전까지는 superuser로만 `ALTER SYSTEM`명령이 가능했으나, 15버전부터 일반 계정에도 `ALTER SYSTEM`권한 부여 가능함. 아래 명령 사용하여 
ALTER SYSTEM 권한 부여 가능
```sql
GRANT ALTER SYSTEM ON PARAMETER wal_retrieve_retry_interval TO repmgr.
```

###### 6. `--superuser` 옵션이 필요한 명령
`repmgr --superuser=postgres` 옵션을 지정하여, superuser의 권한이 필요할 때 postgres의 권한을 빌어 작업할 수 있게 함.
- `repmgr standby clone` : `--copy-external-config-files` 옵션 수행시 필요
- `repmgr standby switchover` : `CHECKPOINT` 명령 수행을 위해 필요
- `repmgr node check` : `repmgr node check --data-directory-config` 명령 수행 위해 필요
- `repmgr node service` : `--checkpoint` 명령으로 checkpoint 실행을 위해 필요.

