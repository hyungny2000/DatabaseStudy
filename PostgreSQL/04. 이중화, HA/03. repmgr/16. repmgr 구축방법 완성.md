## repmgr 구축방법 완성

#### 1. 노드 구성
1. 마스터, 스탠바이, witness 노드 준비 (Witness노드는 선택)
2. PostgreSQL 설치 (최소 15버전 이상)
3. 각 노드별 initdb (스탠바이는 생략해도 됨)
4. IP 설계 (고정IP, VIP등)
5. 각 노드 간의 Passwordless SSH 설정

#### 2. REPMGR 설정 (모든 노드)
1. 각 노드 별 repmgr 패키지 설치
2. 각 노드 별 repmgr.conf 생성 및 설정
   1. (중요) use_replication_slots=true 설정 필요
4. 마스터 노드의 repmgr 설정
   1. repmgr 계정을 non-superuser로 생성
   2. repmgr 계정을 소유주로 하여 repmgr 데이터베이스 생성
   3. template1을 포함한 모든 데이터베이스에 접속하여 `create extension repmgr` 명령 실행
   4. pg_hba.conf파일에 repmgr 계정 관련 접속권한 부여 (trust가 아닌 md5 인증방식 사용)
   5. archive_mode=always, archive_command 설정. archive 디렉토리 생성
   6. 마스터 노드의 postgres OS계정 홈 디렉토리에 .pgpass 파일 생성 및 repmgr 계정 패스워드 입력
   7. `repmgr primary register`로 마스터노드 등록
5. 스탠바이 노드의 repmgr 설정
   1. 스탠바이 노드의 데이터 디렉토리에 기존 파일 제거
   2. archive 디렉토리 생성
   3. 스탠바이 노드의 postgres OS계정 홈 디렉토리에 .pgpass파일 생성 및 repmgr 계정 패스워드 입력
   4. `repmgr standby clone`명령으로 마스터노드로부터 파일 복제하기
   5. 스탠바이DB 기동
   6. `repmgr standby register`로 스탠바이노드 등록
6. Witness 노드의 repmgr 설정
   1. repmgr 계정을 non-superuser로 생성
   2. repmgr 계정을 소유주로 하여 repmgr 데이터베이스 생성
   3. template1을 포함한 모든 데이터베이스에 접속하여 create extension repmgr 명령 실행
   4. pg_hba.conf파일에 repmgr계정 관련 접속권한 부여 (md5 인증방식 사용)
   6. witness 노드의 postgres OS계정 홈 디렉토리에 .pgpass파일 생성 및 repmgr 계정 패스워드 입력
   7. `repmgr witness register`로 witness노드 등록
7. 마스터/스탠바이/witness노드 repmgrd 데몬 기동

#### 3. keepalived 설정 (마스터/스탠바이)
1. 각 노드 별 keepalived 패키지 설치
2. `mv /etc/keepalived/keepalived.conf keepalived.conf.orig`하여 원 설정파일 백업
3. 새 keepalived.conf 생성하여 설정입력
4. repmgr설정 디렉토리에 track_script 생성 (keepalived_pgsql_chk.sh)
   1. primary조건 만족하면 `exit 0`, 아니면 `exit 1`로 종료
   2. root계정에서 `sh keepalived_pgsql_chk.sh` 실행하여 정상여부 테스트해야 함.
5. systemctl enable keepalived
6. systemctl start keepalived
7. ip addr로 VIP 점검
