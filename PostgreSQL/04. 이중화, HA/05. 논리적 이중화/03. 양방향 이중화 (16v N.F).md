# 양방향 이중화 (16v N.F).md
## 양방향 이중화
- Active/Active구성
- origin 파라미터 도입

## origin 파라미터
- 이중화 변경사항의 출처 같은 기능.
- 이중화 무한루프를 방지하는 용도.
- origin정보가 없다는 것은, 해당 변경사항의 출처는 자기 노드라는 의미.
- origin정보가 있다는 것은 해당 변경사항은 자기가 아닌 타 노드로부터 전달받았다는 의미.  
- 설정값
  - none : origin 정보가 없는 변경사항만 전파. 무한루프 방지.
  - any : origin 유무와 관계없이 전파. 기본값이며, 이중화 무한루프 유발가능.
 
## 양방향 이중화 구축 (양 노드 모두 설정해야 함.)
1. PostgreSQL 16 버전의 Docker Container 생성
    ```
    docker run -d -it --name postlr01 --hostname postlr01 --net mybridge --ip 172.20.0.115 --privileged postgres16-test:latest /sbin/init
    docker run -d -it --name postlr02 --hostname postlr02 --net mybridge --ip 172.20.0.116 --privileged postgres16-test:latest /sbin/init
    ```
2. initdb
    ```
    initdb
    ```
3. postgresql.conf에 논리적 이중화 설정
    ```
    listen_addresses = '*'
    wal_level = logical
    ```
4. DB접속, 이중화 대상 DB계정과 DB생성
    ```
    psql

    create user nano superuser encrypted password 'nano';

    create database nano owner nano;
    ```
5. pg_hba.conf에 이중화 DB계정 접근권한 설정 및 적용
    ```
    host   all       nano      172.20.0.1/16     md5
    ```
6. DB접속, 테이블 생성
    ```
    psql -d nano -U nano
    ```
7. 양 노드에 publisher 생성
    ```
    -- postlr01
    create publication my_pub1 for table test1;

    -- postlr02
    create publication my_pub2 for table test1;
    ```
8. 양 노드에 subscriber 생성
    ```
    -- postlr01
    create subscription my_sub2 connection 'host=172.20.0.116 dbname=nano user=nano password=nano' publication my_pub2 with (copy_data=false, origin=none);

    -- postlr02
    create subscription my_sub1 connection 'host=172.20.0.115 dbname=nano user=nano password=nano' publication my_pub1 with (copy_data=false, origin=none);
    ```
9.  입출력 테스트 (postlr01에서 insert)
    ```
    -- postlr01
    nano=# insert into test1 values (1);
    INSERT 0 1
    nano=# select * from test1;
     col1
    ------
        1
    (1 row)

    -- postlr02
    nano=# select * from test1;
     col1
    ------
        1
    (1 row)
    ```
10. 입출력 테스트 (postlr02에서 insert)
    ```
    -- postlr02
    insert into test1 values (2);
    INSERT 0 1

    --postlr01
    nano=# select * from test1;
     col1
    ------
        1
        2
    (2 rows)

    select * from test1; 
     col1
    ------
        1
        2
    (2 rows)
    ```

