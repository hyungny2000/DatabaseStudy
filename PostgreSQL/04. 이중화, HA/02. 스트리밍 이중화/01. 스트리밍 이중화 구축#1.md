## 스트리밍 이중화 구축#1

#### 네트워크 생성
```
docker network create --subnet 172.20.0.0/16 mybridge
```

#### Docker 컨테이너 실행
```
docker run -d -it --name postsr01 --hostname postsr01 --net mybridge --ip 172.20.0.110 --privileged postgres12-test:latest /sbin/init
docker run -d -it --name postsr02 --hostname postsr02 --net mybridge --ip 172.20.0.111 --privileged postgres12-test:latest /sbin/init
```

#### 컨테이너 접속
```
docker exec -it postsr01 /bin/bash
docker exec -it postsr02 /bin/bash
```

#### postsr01(마스터DB)서버 DB기동
```
pg_ctl start
```

#### 이중화 계정 생성
```sql
create user repuser with replication encrypted password 'repuser';
```

#### pg_hba.conf에 아래 추가
```
host      replication      repuser     172.20.0.1/16     md5
:wq
```

#### postsr01(마스터) Reload
```
pg_ctl reload
```
#### postsr02(스탠바이)의 데이터 디렉토리 비우기
```
rm -rf $PGDATA/*
```


#### postsr02(스탠바이)의 pg_basebackup 을 이용하여 복사해오기
```
pg_basebackup -D $PGDATA -h 172.20.0.110 -U repuser -p 5432 -Fp -Xs -P -R -C -S rep_slot_01
```
- `-D` : 복사 대상 디렉토리. (데이터 디렉토리로 설정)
- `-h` : 마스터DB서버의 IP
- `-U` : 이중화 전용 DB계정
- `-p` : 마스터DB 포트
- `-Xs` : Wal Log 전송모드를 Stream으로 설정
- `-Fp` : 파일(File)을 일반(Plain)파일로 전송
  - `-Ft` : 압축파일(tar)로 전송
- `-P` : 전송 진행률 (Progresss) 표시
- `-R` : 이중화(Replication) 정보 기재
- `-C` : 마스터DB에 이중화 슬롯 생성
- `-S <repl_slot_name>` : 이중화 슬롯명


#### 백업 끝나고 조회결과 파일 생성완료
```
[postgres@postsr02 data]$ ls -rlth
total 128K
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_serial
-rw------- 1 postgres postgres  224 Feb  5 10:57 backup_label
drwx------ 3 postgres postgres 4.0K Feb  5 10:57 pg_wal
drwx------ 4 postgres postgres 4.0K Feb  5 10:57 pg_multixact
drwx------ 5 postgres postgres 4.0K Feb  5 10:57 base
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_xact
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_stat
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_commit_ts
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 log
-rw------- 1 postgres postgres  27K Feb  5 10:57 postgresql.conf
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_twophase
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_tblspc
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_subtrans
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_stat_tmp
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_snapshots
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_replslot
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_notify
drwx------ 4 postgres postgres 4.0K Feb  5 10:57 pg_logical
-rw------- 1 postgres postgres 1.6K Feb  5 10:57 pg_ident.conf
-rw------- 1 postgres postgres 4.8K Feb  5 10:57 pg_hba.conf
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_dynshmem
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 global
-rw------- 1 postgres postgres   30 Feb  5 10:57 current_logfiles
-rw------- 1 postgres postgres    3 Feb  5 10:57 PG_VERSION
-rw------- 1 postgres postgres    0 Feb  5 10:57 standby.signal -- 스탠바이DB임을 표시하는 파일. 0바이트가 특징
-rw------- 1 postgres postgres  296 Feb  5 10:57 postgresql.auto.config
[postgres@postsr02 data]$
```
- standby.signal 파일이 생성됨
- postgresql.auto.config 파일에 이런 내용이 있음
```
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
primary_conninfo = 'user=repuser password=repuser host=172.20.0.110 port=5432 sslmode=prefer sslcompression=0 gssencmode=prefer krbsrvname=postgres target_session_attrs=any'
primary_slot_name = 'rep_slot_01'

- primary_conninfo : 마스터DB 접속정보
- primary_slot_name : 마스터DB의 물리적 동기화 슬롯이름
```

#### 스탠바이DB 기동
```
pg_ctl start
```

스탠바이DB 기동시 로그
```
2025-02-05 10:54:44.723 UTC [119] LOG:  database system was shut down at 2025-02-03 13:05:18 UTC
2025-02-05 10:54:44.731 UTC [117] LOG:  database system is ready to accept connections
2025-02-05 10:59:22.393 UTC [124] LOG:  database system was interrupted; last known up at 2025-02-05 10:57:09 UTC
2025-02-05 10:59:22.561 UTC [124] LOG:  entering standby mode
2025-02-05 10:59:22.565 UTC [124] LOG:  redo starts at 0/4000028
2025-02-05 10:59:22.566 UTC [124] LOG:  consistent recovery state reached at 0/4000138
2025-02-05 10:59:22.566 UTC [122] LOG:  database system is ready to accept read only connections -- 읽기전용 연결만 받음
2025-02-05 10:59:22.571 UTC [128] LOG:  started streaming WAL from primary at 0/5000000 on timeline 1
~                                                                                                        
```
### 스탠바이DB 쓰기 테스트
```
[postgres@postsr02 log]$ psql
psql (12.22)
Type "help" for help.

postgres=# \l
                             List of databases
   Name    |  Owner   | Encoding  | Collate | Ctype |   Access privileges
-----------+----------+-----------+---------+-------+-----------------------
 postgres  | postgres | SQL_ASCII | C       | C     |
 template0 | postgres | SQL_ASCII | C       | C     | =c/postgres          +
           |          |           |         |       | postgres=CTc/postgres
 template1 | postgres | SQL_ASCII | C       | C     | =c/postgres          +
           |          |           |         |       | postgres=CTc/postgres
(3 rows)

postgres=# create database nano;
ERROR:  cannot execute CREATE DATABASE in a read-only transaction -- 읽기전용DB에서 데이터베이스 생성은 불가능
postgres=#
```

#### 마스터DB의 이중화 정보 조회결과
```
postgres=# select * from pg_replication_slots;
-[ RECORD 1 ]-------+------------
slot_name           | rep_slot_01
plugin              |
slot_type           | physical
datoid              |
database            |
temporary           | f
active              | t
active_pid          | 138
xmin                |
catalog_xmin        |
restart_lsn         | 0/5000060
confirmed_flush_lsn |

postgres=# select * from pg_stat_replication;
-[ RECORD 1 ]----+------------------------------
pid              | 138
usesysid         | 16384
usename          | repuser
application_name | walreceiver
client_addr      | 172.20.0.111
client_hostname  |
client_port      | 54748
backend_start    | 2025-02-05 10:59:22.569858+00
backend_xmin     |
state            | streaming
sent_lsn         | 0/5000060
write_lsn        | 0/5000060
flush_lsn        | 0/5000060
replay_lsn       | 0/5000060
write_lag        |
flush_lag        |
replay_lag       |
sync_priority    | 0
sync_state       | async
reply_time       | 2025-02-05 11:01:52.982232+00
```

#### 마스터DB에서 nano 데이터베이스, test1 테이블 생성
```
postgres=# create database nano;
CREATE DATABASE
postgres=# \c nano
You are now connected to database "nano" as user "postgres".
nano=# create table test1 (col1 int primary key);
CREATE TABLE
nano=# insert into test1 values (1);
INSERT 0 1
nano=# insert into test1 values (2);
INSERT 0 1
nano=# insert into test1 values (3);
INSERT 0 1
nano=# insert into test1 values (4);
INSERT 0 1
nano=# insert into test1 values (5);
INSERT 0 1
nano=# select  * from test1;
-[ RECORD 1 ]
col1 | 1
-[ RECORD 2 ]
col1 | 2
-[ RECORD 3 ]
col1 | 3
-[ RECORD 4 ]
col1 | 4
-[ RECORD 5 ]
col1 | 5

Expanded display is off.
nano=# select  * from test1;
 col1
------
    1
    2
    3
    4
    5
(5 rows)
```

#### 스탠바이DB에서 nano 데이터베이스, test1 테이블 조회
```
postgres=# \l
                             List of databases
   Name    |  Owner   | Encoding  | Collate | Ctype |   Access privileges
-----------+----------+-----------+---------+-------+-----------------------
 nano      | postgres | SQL_ASCII | C       | C     |
 postgres  | postgres | SQL_ASCII | C       | C     |
 template0 | postgres | SQL_ASCII | C       | C     | =c/postgres          +
           |          |           |         |       | postgres=CTc/postgres
 template1 | postgres | SQL_ASCII | C       | C     | =c/postgres          +
           |          |           |         |       | postgres=CTc/postgres
(4 rows)

postgres=# \c nano -- 마스터DB에서 생성한 nano 데이터베이스가 동기화되어 생성됨
You are now connected to database "nano" as user "postgres".
nano=# select * from test1;
 col1
------
    1
    2
    3
    4
    5 -- 데이터 동기화 완료
(5 rows)

nano=#
```
