## 스트리밍 이중화 Fail-Over

#### 장애 시나리오
1. 마스터DB인 postsr01 DB shutdown
2. 스탠바이DB인 postsr02 DB를 마스터로 승격(promote)


#### postsr01 DB shutdown
```
pg_ctl stop
```

#### 스탠바이DB의 로그 확인
마스터DB 연결불가 메시지 확인
```
2025-02-05 11:09:17.469 UTC [136] FATAL:  could not connect to the primary server: could not connect to server: Connection refused
                Is the server running on host "172.20.0.110" and accepting
                TCP/IP connections on port 5432?
2025-02-05 11:09:22.473 UTC [137] FATAL:  could not connect to the primary server: could not connect to server: Connection refused
                Is the server running on host "172.20.0.110" and accepting
                TCP/IP connections on port 5432?
2025-02-05 11:09:27.477 UTC [138] FATAL:  could not connect to the primary server: could not connect to server: Connection refused
                Is the server running on host "172.20.0.110" and accepting
                TCP/IP connections on port 5432?
2025-02-05 11:09:32.486 UTC [139] FATAL:  could not connect to the primary server: could not connect to server: Connection refused
                Is the server running on host "172.20.0.110" and accepting
                TCP/IP connections on port 5432?
2025-02-05 11:09:37.486 UTC [140] FATAL:  could not connect to the primary server: could not connect to server: Connection refused
                Is the server running on host "172.20.0.110" and accepting
                TCP/IP connections on port 5432?
2025-02-05 11:09:42.491 UTC [142] FATAL:  could not connect to the primary server: could not connect to server: Connection refused
                Is the server running on host "172.20.0.110" and accepting
                TCP/IP connections on port 5432?
2025-02-05 11:09:47.501 UTC [144] FATAL:  could not connect to the primary server: could not connect to server: Connection refused
                Is the server running on host "172.20.0.110" and accepting
                TCP/IP connections on port 5432?
```

#### 스탠바이DB를 마스터로 승격(Promote)시키기
```
pg_ctl promote
```
```
waiting for server to promote.... done
server promoted
```

#### 신규 마스터DB로 승격여부 확인
```
[postgres@postsr02 data]$ ls -rlth
total 136K
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_serial
-rw------- 1 postgres postgres  224 Feb  5 10:57 backup_label.old
drwx------ 4 postgres postgres 4.0K Feb  5 10:57 pg_multixact
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_xact
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_stat
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_commit_ts
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 log
-rw------- 1 postgres postgres  27K Feb  5 10:57 postgresql.conf
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_twophase
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_tblspc
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_snapshots
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_replslot
-rw------- 1 postgres postgres 1.6K Feb  5 10:57 pg_ident.conf
-rw------- 1 postgres postgres 4.8K Feb  5 10:57 pg_hba.conf
drwx------ 2 postgres postgres 4.0K Feb  5 10:57 pg_dynshmem
-rw------- 1 postgres postgres    3 Feb  5 10:57 PG_VERSION
-rw------- 1 postgres postgres  296 Feb  5 10:57 postgresql.auto.conf
-rw------- 1 postgres postgres   27 Feb  5 10:59 postmaster.opts
drwx------ 2 postgres postgres 4.0K Feb  5 10:59 pg_notify
-rw------- 1 postgres postgres   30 Feb  5 10:59 current_logfiles
drwx------ 2 postgres postgres 4.0K Feb  5 11:04 pg_subtrans
drwx------ 6 postgres postgres 4.0K Feb  5 11:04 base
drwx------ 2 postgres postgres 4.0K Feb  5 11:06 global
-rw------- 1 postgres postgres   94 Feb  5 11:10 postmaster.pid
drwx------ 3 postgres postgres 4.0K Feb  5 11:10 pg_wal
drwx------ 4 postgres postgres 4.0K Feb  5 11:10 pg_logical
drwx------ 2 postgres postgres 4.0K Feb  5 11:10 pg_stat_tmp
-- standby.signal 삭제됨

[postgres@postsr02 data]$ psql
psql (12.22)
Type "help" for help.
postgres=# select * from pg_is_in_recovery();
 pg_is_in_recovery
-------------------
 f -- False로 마스터DB를 의미함
(1 row)

```
#### postgresql.auto.conf 확인
```
[postgres@postsr02 data]$ cat postgresql.auto.conf
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
primary_conninfo = 'user=repuser password=repuser host=172.20.0.110 port=5432 sslmode=prefer sslcompression=0 gssencmode=prefer krbsrvname=postgres target_session_attrs=any'
primary_slot_name = 'rep_slot_01'
-- 기존 마스터DB 설정값은 여전히 존재하나 스탠바이모드가 아니므로 무의미함
```
