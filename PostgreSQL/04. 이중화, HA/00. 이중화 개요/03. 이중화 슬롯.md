## 이중화 슬롯

#### 이중화 슬롯이란
PostgreSQL에서 스트리밍 이중화, 논리적 이중화는 모두 이중화 슬롯을 이용하여 스탠바이DB와의 이중화정보를 관리한다. 마스터DB서버 데이터 디렉토리의 pg_replslot에 이중화슬롯의 물리파일이 위치한다. 스트리밍 이중화를 위한 물리적(Physical) 이중화 슬롯, 논리적 이중화를 위한 논리적(Logical) 이중화 슬롯으로 나누지만, 역할은 똑같다.

#### 이중화 슬롯의 역할
이중화 슬롯의 주요 역할은 스탠바이DB와의 통신이 안될 때, pg_wal에 있는 WAL File이 최대한 보존되게 하는 것이다. 스탠바이DB가 정지된 상황에서 마스터DB는 스탠바이DB에 적용시킬 WAL Log를 전송할 수 없게 된다. 이대로 아무 조치도 하지 않으면 시간이 지나면서 오래된 WAL이 자연히 삭제되거나([WAL_KEEP_SIZE 파라미터](https://postgresqlco.nf/doc/en/param/wal_keep_size/)) 재사용된다. 하여 WAL File이 소실되면 스탠바이DB가 재기동되었을 때 적용해야 할 WAL이 없어져 이중화는 깨지게 된다. 이러한 이유로 중단된 스탠바이DB가 재기동되었을 때를 대비하여 WAL LOG가 삭제되지 않게 해야 한다.

#### 이중화 슬롯 관리
1. 현재 이중화 슬롯 목록 확인
   - `select * from pg_replication_slots`
2. 물리적 이중화 슬롯 생성
   - `select pg_create_physical_replication_slot('repl_slot_name');`
3. 논리적 이중화 슬롯 생성
   - `select pg_create_logical_replication_slot('repl_slot_name');`
4. 이중화 슬롯 삭제
   - `select pg_drop_replication_slot('repl_slot_name');`
5. 이중화 슬롯으로부터 변경내용 조회

6. 이중화 슬롯이 점유하는 WAL 파일 용량 조회
```sql
SELECT slot_name, pg_size_pretty(pg_replication_slot_advance(slot_name, restart_lsn))
FROM pg_replication_slots;
```
