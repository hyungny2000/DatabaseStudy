# PostgreSQL의 이중화

## wal_level 파라미터
1. minimal : Crash Recovery에 필요한 정도로 최소한의 복구내용만 기록. Archive Mode On설정 불가.
2. replica : 물리적 이중화를 위한 설정값. 
3. logical : 논리적 이중화를 위한 설정값.

## 물리적 이중화
### 정의
- 마스터에서 발생한 물리 데이터파일의 변경사항을 스탠바이 서버로 전달하는 방식의 이중화
- Active/Standby 구조
- Log Shipping 방식과 WAL 스트리밍 방식으로 구분 가능하다. 모두 WAL Log를 매개로 이중화된다.

### 특징
- 마스터/스탠바이 간 DB클러스터의 **모든 데이터파일을 동기화**해야 한다. 특정 테이블, 특정 데이터베이스만 동기화할 수 없다.
- 마스터/스탠바이DB의 **DB버전, 데이터디렉토리 구조 등이 모두 동일**해야 한다.
- DML, DDL 등 모든 변경사항이 전달된다.
- 마스터/스탠바이 간의 **네트워크 부하가 상대적으로 크다.**

#### Log Shipping 이중화
- 마스터에서 발생한 WAL Archive 파일 자체를 스탠바이 서버에 전달하는 이중화 방식
- WAL Archive가 생성되어야 변경사항이 전달되므로 마스터 서버와 스탠바이 서버 간의 Gap이 존재한다.

#### WAL 스트리밍 방식의 이중화
- 마스터 서버에서 WAL Log가 생성될 때마다 스탠바이 서버로 전송하는 스트리밍 방식의 이중화
- 마스터/스탠바이 간의 실시간 이중화로 Log Shipping에 비해 Gap이 매우 적다. Log Shipping에 비해 훨씬 많이 사용함.
- 동기식/비동기식 설정이 가능하다. 기본값은 비동기.

## 논리적 이중화
### 정의
- 마스터에서 실행한 SQL작업을 스탠바이에서 재생하는 방식의 이중화.
- WAL Log의 내용을 WAL Decoder를 통해 SQL로 변환한 다음 전송한다.
- 기본적으로 Active/Standby이나 v16부터 Active/Active 이중화 지원.

### 특징
- 마스터 서버에서 특정 데이터베이스의 테이블 전체, 또는 특정 테이블만을 선택적으로 동기화할 수 있다.
- Row Filtering 기능이 있어, 테이블 내에서 조건을 만족하는 데이터만 동기화할 수 있다.
- 마스터/스탠바이 DB간 SQL만 전송되므로 **DB버전, 데이터디렉토리 구조가 동일하지 않아도 된다.**
- 테이블의 DML만 동기화 대상. DDL은 마스터/스탠바이 간에 따로 진행해야 한다.

## 물리적/논리적 이중화 비교
| 항목 | 물리적 이중화 | 논리적 이중화 |
| :---: | :---: | :---: |
| 이중화 대상 | DB클러스터 전체 | 특정 데이터베이스, 특정 테이블 선택 가능 |
| DB버전 | 동일해야 한다 | 동일하지 않아도 된다. |
| DB클러스터 구조 | 동일해야 한다 | 동일하지 않아도 된다. |
| 양방향 이중화 | 미지원 | v16부터 지원 | 
| 이중화 작업대상 | 모든 변경사항 | DML만 지원 |
