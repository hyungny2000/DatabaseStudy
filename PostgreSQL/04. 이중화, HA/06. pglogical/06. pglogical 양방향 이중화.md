# 양방향 이중화 (Bidirectional replication)

## 참고자료
- [James armes 홈페이지](https://www.jamesarmes.com/2023/03/bidirectional-replication-postgresql-pglogical.html)
- [pglogical Github](https://github.com/2ndQuadrant/pglogical/tree/REL2_x_STABLE#subscription-management)

## 개념
- 양측 노드가 모두 읽기/쓰기가 가능한 논리적 이중화 구성
- 읽기/쓰기 부하 분산 용도의 구성
- 별도 설정없이 양방향 이중화 구현 시, 변경사항이 양 노드 사이를 왔다갔다 하면서 무한 실행되는 에러가 발생함.
- 이를 막기 위해, 상대 공급자 노드에서 변경된 사항만 반영하는 옵션이 필요함.
- pglogical에서는 forward_origins 파라미터를 양방향 이중화 옵션으로 제공

## create_subscription 프로시저의 forward_origins 파라미터
- 전달할 원본 이름 배열
- `forward_origins := '{}'`으로 설정하여, 공급자 노드에서 시작되지 않은 변경사항은 전달하지 않는다는 의미로 설정.

## 양방향 이중화 구성
1. (postpl01) pglogical 노드 생성
    ```
    SELECT pglogical.create_node(
        node_name := 'node_postpl01',
        dsn := 'host=172.20.0.120 port=5432 dbname=nano'
    );
    ```
2. (postpl02) pglogical 노드 생성
    ```
    SELECT pglogical.create_node(
        node_name := 'node_postpl02',
        dsn := 'host=172.20.0.121 port=5432 dbname=nano'
    );
    ```
3. (postpl02) 구독자 생성
    ```
    SELECT pglogical.create_subscription(
        subscription_name := 'subscription_postpl01',
        provider_dsn := 'host=172.20.0.120 port=5432 dbname=nano' ,
        forward_origins := '{}'
    );

    SELECT pglogical.wait_for_subscription_sync_complete('subscription_postpl01');
    ```
4. (postpl01) 구독자 생성
    ```
    SELECT pglogical.create_subscription(
        subscription_name := 'subscription_postpl02',
        provider_dsn := 'host=172.20.0.121 port=5432 dbname=nano' ,
        forward_origins := '{}'
    );
    
    
    ```
5. (postpl01/02) 구독자 상태 체크
    ```
    nano=# SELECT * FROM pglogical.show_subscription_status();
    -[ RECORD 1 ]-----+----------------------------------------
    subscription_name | subscription_postpl02
    status            | replicating
    provider_node     | node_postpl02
    provider_dsn      | host=172.20.0.121 port=5432 dbname=nano
    slot_name         | pgl_nano_node_postpl02_subscrip116b989
    replication_sets  | {default,default_insert_only,ddl_sql}
    forward_origins   |
 
 
     nano=# SELECT * FROM pglogical.show_subscription_status();
    -[ RECORD 1 ]-----+----------------------------------------
    subscription_name | subscription_postpl01
    status            | down -- 이상함.
    provider_node     | node_postpl01
    provider_dsn      | host=172.20.0.120 port=5432 dbname=nano
    slot_name         | pgl_nano_node_postpl01_subscrip8579d2f
    replication_sets  | {default,default_insert_only,ddl_sql}
    forward_origins   |

    nano=# select pglogical.alter_subscription_enable('subscription_postpl01', true);
    -[ RECORD 1 ]-------------+--
    alter_subscription_enable | t

    nano=# SELECT * FROM pglogical.show_subscription_status();
    -[ RECORD 1 ]-----+----------------------------------------
    subscription_name | subscription_postpl01
    status            | down
    provider_node     | node_postpl01
    provider_dsn      | host=172.20.0.120 port=5432 dbname=nano
    slot_name         | pgl_nano_node_postpl01_subscrip8579d2f
    replication_sets  | {default,default_insert_only,ddl_sql}
    forward_origins   |
    ```
    - subscription_postpl01 구독자가 down상태임. 원인파악 요령부터 익혀야 할 듯

## 양방향 이중화 테이블 등록
1. (postpl01/postpl02) 테이블 생성
     ```
     create table test1 (col1 int primary key, col2 varchar);
     ```
2. (post01/postpl02) 테이블 이중화 대상 등록
     ```
     SELECT pglogical.replication_set_add_all_tables('default', ARRAY['public']);
     ```

## 양방향 이중화 DML 테스트
1. (postpl01) 데이터 입력
    ```
    insert into test1 values (1,'test');
    select * from test1;
     col1 | col2
    ------+------
        1 | test
    ```
2. (postpl02) 데이터 조회
    ```
    select * from test1;
     col1 | col2
    ------+------
    (0 rows)
    ```
3. (postpl02) 데이터 입력
    ```
    nano=# insert into test1 values (1,'test');
    INSERT 0 1
    nano=# select * from test1;
     col1 | col2
    ------+------
        1 | test
    (1 row)
   ```

4. (postpl01) 데이터 조회
    ```
    nano=# select * from test1;
     col1 | col2
    ------+------
        1 | test
    (1 row)
    ```

## 양방향 이중화 DDL 동기화 테스트
